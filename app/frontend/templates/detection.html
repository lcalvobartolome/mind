{% extends "base.html" %}
{% block title %}Detection{% endblock %}

{% block content %}
<h1>MIND Cultural discrepancy detection</h1>
<div class="jumbotron" id='jumbotron-detection' style="height: 60vh; overflow-y: auto; padding: 2rem;">
    {% if status in ['idle', 'initializing'] %}        
        {% if dataset_detection %}
            <p class="lead">Start a session by selecting a dataset and a topic model associated:</p>
            <div class="dataset-accordion">
                {% for dataset, topicmodel_list in dataset_detection.items() %}
                <div class="dataset-group mb-3 border rounded-2 shadow-sm">

                    <div class="dataset-header list-group-item hover-text-primary fw-bold bg-light" 
                        role="button"
                        aria-expanded="false"
                        aria-controls="content-{{ loop.index }}"
                        style="cursor:pointer; border:none;">
                        Dataset: {{ dataset }}
                        <span class="chev" aria-hidden="true" style="float:right; transition: transform .2s;">▸</span>
                    </div>

                    <ul id="content-{{ loop.index }}" class="list-group dataset-list" 
                        style="display:none; background-color:#f8f9fa; margin:0; border-top:1px solid #ddd;">
                        {% for tm in topicmodel_list %}
                        <li class="list-group-item dataset-item hover-text-primary dataset-entry" 
                            style="background-color:#f0f0f0; border:none; border-bottom:1px solid #e0e0e0;"
                            dataset-tm='{ "dataset_name": "{{ dataset }}", "topic_model": "{{ tm }}" }'>
                            <a class="dataset-link d-block px-2 py-1">
                                Topic Model: {{ tm }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>

        {% elif topic_keys %}
            <p class="lead">Select topics from the Topic Model "{{ topic_keys["TM_name"] }}":</p>
            <div class="topic-accordion">
                {% set first_lang = topic_keys["lang"][0] %}
                {% set topic_ids = topic_keys[first_lang].keys() %}
                {% for topic_id in topic_ids %}
                <div class="topic-group mb-3 border rounded-2 shadow-sm">
                    
                    <div class="dataset-header topic-header list-group-item hover-text-primary fw-bold bg-light d-flex align-items-center justify-content-between"
                        role="button"
                        aria-expanded="false"
                        aria-controls="topic-content-{{ loop.index }}"
                        style="cursor:pointer; border:none;">
                        
                        <div class="d-flex align-items-center"
                            style="margin-left: 15px;">
                            <input type="checkbox" class="form-check-input topic-checkbox"
                                name="topic_select"
                                value="{{ topic_id }}"
                                TM-name='{{ topic_keys["TM_name"] }}'
                                style="cursor:pointer; margin-right:10px; margin-top: 0px; transform:scale(1.1); accent-color:#0d6efd;">
                            <label class="mb-0"> Topic {{ topic_id }}</label>
                        </div>
                        
                        <div class="d-flex align-items-center">
                            <span class="chev" aria-hidden="true" style="transition: transform .2s;">▸</span>
                        </div>
                    </div>

                    <ul id="topic-content-{{ loop.index }}" class="list-group topic-list"
                        style="display:none; background-color:#f8f9fa; margin:0; border-top:1px solid #ddd;">
                        {% for lang in topic_keys["lang"] %}
                            {% if topic_keys[lang][topic_id] is defined %}
                            <li class="list-group-item topic-item"
                                style="background-color:#f0f0f0; border:none; border-bottom:1px solid #e0e0e0;">
                                {{ lang }}: {{ topic_keys[lang][topic_id] | join(' ') }}
                            </li>
                            {% endif %}
                        {% endfor %}
                    </ul>

                </div>
                {% endfor %}
            </div>

        {% else %}
            <p class="lead">No datasets found or error loading datasets.</p>
        {% endif %}

    {% elif status in ['initialized','topic_exploration']%}
        {% if not mind_info %}
            <p class="lead">MIND is initialized.</p>
            <p>Inspect the available topics or start analysis.</p>
        {% else %}
            <div class="card shadow-sm mb-4" id="topic-list-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Available topics for exploration</h5>
                    
                    <div>
                        <a href="#" id="list-view-btn" class="text-white fw-bold me-3 active-view">List</a>
                        <a href="#" class="text-white fw-bold" style="opacity: 0; pointer-events: none;"> | </a>
                        <a href="#" id="graph-view-btn" class="text-white fw-bold" style="opacity: 0; pointer-events: none;">Graph</a>
                    </div>
                </div>

                <div id="topic-list-view">
                    <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            {% for topic in mind_info %}
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>Topic {{ topic["Topic #"] }}:</strong>
                                        <span class="text-muted">{{ topic["Key words"] }}</span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary topic_button" data-topic-id="{{ topic['Topic #'] }}">Select</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- GRAPH VIEW -->
                <div id="topic-graph-view" class="d-none">
                    <div class="card-body" style="height: 400px; overflow: hidden;">
                        <iframe id="pyldavis-frame" src="" style="border: none; width: 100%; height: 100%;"></iframe>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4 d-none" id="document-carousel-card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Documents for selected topic</h5>
                </div>
                <div class="card-body">
                    <div id="document-carousel" class="carousel slide" data-ride="carousel">
                        <div class="carousel-inner" id="carousel-inner">
                            {% for doc in documents %}
                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                <div class="card shadow-sm border-0">
                                    <div class="row g-0 align-items-center">
                                        
                                        <!-- Document text -->
                                        <div class="col-md-8 p-3">
                                            <div class="doc-text" style="max-height: 300px; overflow-y: auto;">
                                                <p class="mb-0">{{ doc.raw_text }}</p>
                                            </div>
                                        </div>

                                        <!-- Topic distribution chart -->
                                        <div class="col-md-4 p-3 text-center">
                                            <h6 class="text-muted mb-2">Topic Distribution</h6>
                                            <canvas id="chart-doc-{{ doc.doc_id }}" style="max-width: 100%; height: auto;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

    {% elif status == 'running' %}
        <p class="lead">MIND is currently running...</p>
    {% elif status == 'completed' %}
        {% if result_mind and result_columns %}
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
            <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">

            <!-- Table Result MIND -->
            <table id="resultsTable" class="table table-striped table-hover table-bordered align-middle">
                <thead class="thead-light">
                    <tr>
                        {% for col in result_columns %}
                            {% if col in ['label', 'final_label'] %}
                            <th class="th-with-filter" style="position: relative;">
                                {{ col }}
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm filter-icon-btn filter-btn"
                                            type="button" id="dropdown{{ loop.index0 }}"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                            data-column="{{ col }}">
                                        <i class="bi bi-droplet"></i>
                                    </button>
                                    <div class="dropdown-menu p-2" aria-labelledby="dropdown{{ loop.index0 }}"
                                        style="max-height: 200px; overflow-y: auto;">
                                        <!-- All -->
                                        <label class="dropdown-item">
                                            <input type="checkbox" class="filter-checkbox" data-value="ALL" checked> All
                                        </label>
                                        {% set label_options = ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY'] %}
                                        {% for val in label_options %}
                                        <label class="dropdown-item">
                                            <input type="checkbox" class="filter-checkbox" data-value="{{ val }}" checked> {{ val }}
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </th>
                            {% else %}
                            <th>{{ col }}</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                {% for row in result_mind %}
                <tr>
                    {% for col in result_columns %}
                        {% if col == 'final_label' %}
                        <td>
                            <div class="custom-select-container">
                                <select class="final-label-select">
                                    {% set options = ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY'] %}
                                    {% for opt in options %}
                                        <option value="{{ opt }}" {% if row['final_label'] == opt %}selected{% endif %}>{{ opt }}</option>
                                    {% endfor %}
                                </select>
                                <span class="custom-arrow">▼</span>
                            </div>
                        </td>
                        {% elif col == 'label' %}
                        <td>
                            <span class="badge-label" data-label-value="{{ row[col] }}">{{ row[col] }}</span>
                        </td>
                        {% else %}
                        <td>{{ row[col] }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-warning text-center mt-5">
                <strong>No hay datos disponibles para mostrar.</strong>
            </div>
        {% endif %}
    {% else %}
    <p>No datasets available.</p>
    {% endif %}
</div>

<div class="modal fade" id="docModal" tabindex="-1" role="dialog" aria-labelledby="docModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="docModalLabel">Document Content</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Loading document content...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% if result_mind and result_columns %}
<div id="datatable-controls-1" class="d-flex align-items-center mb-2">
    <!-- Filter Columns -->
    <button class="btn btn-light dropdown-toggle" type="button" id="columnFilterBtn" style="margin-right: 15px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Filter Columns
    </button>
    <div class="dropdown-menu p-3" aria-labelledby="columnFilterBtn" style="max-height: 250px; overflow-y: auto;">
        <div class="form-check">
            <input class="form-check-input column-checkbox" type="checkbox" value="ALL" id="columnAll" checked>
            <label class="form-check-label" for="columnAll">All</label>
        </div>
        {% for col in result_columns %}
        <div class="form-check">
            <input class="form-check-input column-checkbox" type="checkbox" value="{{ col }}" id="column_{{ loop.index0 }}" checked>
            <label class="form-check-label" for="column_{{ loop.index0 }}">{{ col }}</label>
        </div>
        {% endfor %}
    </div>
</div>
<div id="datatable-controls-2" class="d-flex justify-content-between mb-3"></div>

<button id="exportXlsxBtn" class="btn btn-success mb-3">
    <i class="bi bi-download"></i> Save & Download XLSX
</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DataTable
    var table = $('#resultsTable').DataTable({
        pageLength: 10,
        columns: {{ columns_json|safe }},
        orderCellsTop: true,
        columnDefs: [
            { 
                orderable: false,
                targets: {{ non_orderable_indices|safe }}
            }
        ],
        language: {
            "zeroRecords": "No records were found",
            "info": "Showing _START_ to _END_ from _TOTAL_ records",
            "infoEmpty": "Showing 0 records",
            "infoFiltered": ""
        }
    });

    var possibleValues = {
        'label': ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY'],
        'final_label': ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY']
    };

    var activeFilters = {
        'label': possibleValues['label'].slice(),
        'final_label': possibleValues['final_label'].slice()
    };

    var visibleColumns = {{ result_columns|tojson|safe }};
    $('body').on('change', '.column-checkbox', function() {
        var value = $(this).val();

        if (value === "ALL") {
            if ($(this).prop('checked')) {
                $('.column-checkbox').prop('checked', true);
                visibleColumns = {{ result_columns|tojson|safe }};
            } else {
                $('.column-checkbox').prop('checked', false);
                visibleColumns = [];
            }
        } else {
            if ($(this).prop('checked')) {
                if (!visibleColumns.includes(value)) visibleColumns.push(value);
            } else {
                visibleColumns = visibleColumns.filter(c => c !== value);
            }

            if (visibleColumns.length === {{ result_columns|length }}) {
                $('#columnAll').prop('checked', true);
            } else {
                $('#columnAll').prop('checked', false);
            }
        }

        table.columns().every(function(index) {
            var colName = this.settings()[0].aoColumns[index].name;
            if (visibleColumns.includes(colName)) {
                this.visible(true);
            } else {
                this.visible(false);
            }
        });
    });
    
    function updateColors() {
        // final_label
        $('.final-label-select').each(function() {
            var value = $(this).val();
            var bgColor, textColor;
            switch(value) {
                case 'CONTRADICTION': bgColor = '#dc3545'; textColor = '#fff'; break;
                case 'CULTURAL_DISCREPANCY': bgColor = '#ffc107'; textColor = '#212529'; break;
                case 'NOT_ENOUGH_INFO': bgColor = '#17a2b8'; textColor = '#fff'; break;
                case 'NO_DISCREPANCY': bgColor = '#28a745'; textColor = '#fff'; break;
                default: bgColor = '#6c757d'; textColor = '#fff';
            }
            $(this).css({ 'background-color': bgColor, 'color': textColor });
            $(this).siblings('.custom-arrow').css('color', textColor);
        });

        // label
        $('.badge-label').each(function() {
            var value = $(this).data('label-value');
            var bgColor, textColor;
            switch(value) {
                case 'CONTRADICTION': bgColor = '#dc3545'; textColor = '#fff'; break;
                case 'CULTURAL_DISCREPANCY': bgColor = '#ffc107'; textColor = '#212529'; break;
                case 'NOT_ENOUGH_INFO': bgColor = '#17a2b8'; textColor = '#fff'; break;
                case 'NO_DISCREPANCY': bgColor = '#28a745'; textColor = '#fff'; break;
                default: bgColor = '#6c757d'; textColor = '#fff';
            }
            $(this).css({ 'background-color': bgColor, 'color': textColor });
        });
    }

    // Colos span label final_label
    updateColors();
    $('body').on('change', '.final-label-select', function() {
        updateColors();
        var row = $(this).closest('tr');
        table.row(row).invalidate().draw(false);
    });

    // Cols filter
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        for (var colName in activeFilters) {
            var selectedValues = activeFilters[colName];
            if (!selectedValues || selectedValues.length === 0) return false;

            var colIndex = table.column(colName + ":name").index();
            var cellNode = table.cell(dataIndex, colIndex).node();

            var cellValue;

            if (colName === 'final_label') {
                cellValue = $(cellNode).find('select.final-label-select').val();
            } else {
                var cellHtml = $(cellNode).html() || "";
                cellValue = cellHtml.replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
            }

            if (!selectedValues.includes(cellValue)) {
                return false;
            }
        }
        return true;
    });

    // User change value final_label
    $('body').on('change', '.final-label-select', function() {
        var row = $(this).closest('tr');
        var value = $(this).val();
        
        var table = $('#resultsTable').DataTable();
        table.row(row).invalidate().draw(false);

        activeFilters['final_label'] = table.rows().nodes().to$().find('.final-label-select').map(function() {
            return $(this).val();
        }).get();
    });

    // Filter checkbox label final_label
    $('body').on('click', '.filter-checkbox', function(e) {
        e.stopPropagation();

        var checkbox = $(this);
        var value = checkbox.data('value');
        var dropdown = checkbox.closest('.dropdown-menu');
        var btn = dropdown.siblings('.filter-btn');
        var colName = btn.data('column');
        var allCheckbox = dropdown.find('input.filter-checkbox[data-value="ALL"]');

        if (!activeFilters[colName]) activeFilters[colName] = [];

        if (value === "ALL") {
            if (checkbox.prop('checked')) {
                activeFilters[colName] = possibleValues[colName].slice();
                dropdown.find('input.filter-checkbox').prop('checked', true);
            } else {
                activeFilters[colName] = [];
                dropdown.find('input.filter-checkbox').prop('checked', false);
            }
        } else {
            if (checkbox.prop('checked')) {
                if (!activeFilters[colName].includes(value)) activeFilters[colName].push(value);
            } else {
                activeFilters[colName] = activeFilters[colName].filter(v => v !== value);
            }

            if (activeFilters[colName].length === possibleValues[colName].length) {
                allCheckbox.prop('checked', true);
            } else {
                allCheckbox.prop('checked', false);
            }
        }

        if (activeFilters[colName].length > 0) {
            btn.removeClass('btn-light').addClass('btn-primary');
        } else {
            btn.removeClass('btn-primary').addClass('btn-light');
        }

        table.draw();
    });

    $('body').on('click', '.dropdown-item', function(e) {
        e.stopPropagation();
    });

    $('.filter-checkbox').each(function() {
        var checkbox = $(this);
        var value = checkbox.data('value');
        var colName = checkbox.closest('.dropdown-menu').siblings('.filter-btn').data('column');
        if (value === "ALL") {
            checkbox.prop('checked', activeFilters[colName].length === possibleValues[colName].length);
        } else {
            checkbox.prop('checked', activeFilters[colName].includes(value));
        }
    });

    table.draw();
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    var lengthDiv = $('#resultsTable_length');
    var label = lengthDiv.find('label');
    var select = label.find('select');

    label.contents().filter(function() {
        return this.nodeType === 3;
    }).remove();

    label.prepend('<span style="white-space: nowrap;">Show entries</span> ');

    label.css({
        display: 'flex',
        alignItems: 'center',
        gap: '5px',
        marginBottom: '0'
    });

    select.addClass('ml-2');

    $('#datatable-controls-1').append(lengthDiv);

    $('#datatable-controls-2').append(
        $('#resultsTable_info'),
        $('#resultsTable_paginate')
    );

    $('#resultsTable_filter').remove();

    document.getElementById('jumbotron-detection').style.marginBottom = '15px';
    document.getElementById('resultsTable_info').style.marginLeft = '10px';
    document.getElementById('resultsTable_length').style.marginLeft = 'auto';
});
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var table = $('#resultsTable').DataTable();

    function exportTableToXLSX(filename = 'results_mind.xlsx') {
        var ws_data = [];

        var headers = [];
        $('#resultsTable thead th').each(function() {
            var cleanHeader = $(this).text().replace('\n', '').replace(' ', '')
            headers.push(cleanHeader);
        });
        ws_data.push(headers);

        table.rows({ search: 'applied' }).every(function() {
            var row = [];
            this.nodes().to$().find('td').each(function() {
                let cell;
                if ($(this).find('select.final-label-select').length) {
                    cell = $(this).find('select.final-label-select').val();
                } else if ($(this).find('.badge-label').length) {
                    cell = $(this).find('.badge-label').data('label-value');
                } else {
                    cell = $(this).text().trim();
                }
                cell = String(cell).replace(/\s+/g, ' ').trim();
                row.push(cell);
            });
            ws_data.push(row);
        });

        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

        var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        var blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

        var formData = new FormData();
        formData.append('file', blob, filename);
        const urlParams = new URLSearchParams(window.location.search);
        formData.append('TM', urlParams.get('TM') || '');
        formData.append('topics', urlParams.get('topics') || '');

        fetch('/update_results', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => console.log(data))
        .catch(err => console.error("Error in XLSX:", err));
        XLSX.writeFile(wb, filename);
    }

    $('#exportXlsxBtn').on('click', function() {
        exportTableToXLSX();
    });
});
</script>

{% elif topic_keys %}
<ul class="nav nav-pills mb-4 d-flex justify-content-between w-100" id="myTab" role="tablist">
    <!-- <li class="nav-item ">
        <a class="nav-link mode-selectors active " href="#input" data-toggle="tab">Explore topics</a>
    </li> -->

    <li class="nav-item d-flex align-items-center"></li>
    <li class="nav-item d-flex align-items-center">
        <!-- Max input = ntopics -->
        <label for="numberInput" class="mr-2 mb-0">Sample Size: </label>
        <input type="number" class="form-control mr-2" id="sampleSizeInput" name="n_samples" placeholder="1" value="5" min="1" style="width: 100px;">
        <a class="nav-link mode-selectors active" id="analyze_contradictions" style="cursor: pointer;" data-toggle="tab">Analyze Discrepancies</a>
        <a class="nav-link mode-selectors active" style="margin-left: 10px; cursor: pointer;" data-toggle="modal" data-target="#logModal">
            Check Status
        </a>
        <!-- <button type="submit" class="btn btn-primary">Submit</button> -->
    </li>
</ul>

<div class="modal fade" id="logModal" tabindex="-1" role="dialog" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalLabel">Pipeline Log</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="logTerminal"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const terminal = $("#logTerminal");

    $('#logModal').on('shown.bs.modal', function () {
        terminal.scrollTop(terminal[0].scrollHeight);
    });

    const evtSource = new EventSource("/stream_detection");

    evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const logLine = data.log;

        terminal.append(document.createTextNode(logLine + "\n"));
        terminal.scrollTop(terminal[0].scrollHeight);
    };

    evtSource.onerror = function(err) {
        console.error("SSE error:", err);
    };
});
</script>
{% endif %}


<!-- <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap"> -->
  <!-- Navigation Pills -->
  <!-- <ul class="nav nav-pills mb-2 mb-md-0" id="myTab" role="tablist">
      <li class="nav-item">
          <a class="nav-link control active" id="prev-doc" data-toggle="tab">Previous</a>
      </li>
      <li class="nav-item">
          <a class="nav-link control" id="next-doc" data-toggle="tab">Next</a>
      </li>
      <li class="nav-item">
          <a class="nav-link control" id="return-btn" data-toggle="tab">Return</a>
      </li>
  </ul> -->
    <!-- <form id="mind-number-form" class="form-inline d-flex align-items-center gap-2"> -->
    <!-- <label for="numberInput" class="mr-2 mb-0"></label> -->
    <!-- Max input = ntopics -->
    <!-- <input type="number" class="form-control mr-2" id="numberInput" name="n_samples" placeholder="0" min="0" style="width: 100px;"> -->
    <!-- <button type="submit" class="btn btn-primary">Submit</button> -->
    <!-- </form> -->
<!-- </div> -->

<style>
    .dataset-entry:hover {
        background-color: #e2e2e2 !important;
        transition: background-color 0.2s ease;
    }

    .dataset-entry:hover a {
        color: #007bff; 
        text-decoration: underline;
    }

    .jumbotron::-webkit-scrollbar {
        width: 8px;
    }
    
    .jumbotron::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 4px;
    }
    
    .jumbotron::-webkit-scrollbar-thumb:hover {
        background-color: #aaa;
    }

    .dataset-link {
        color: #000 !important;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .dataset-entry:hover .dataset-link {
        color: #007bff !important;
        text-decoration: underline;
    }

    th.th-with-filter {
        position: relative;
        padding-right: 32px !important;
        min-width: 240px;
        max-width: 240px;
        white-space: nowrap;
    }

    .filter-icon-btn {
        position: absolute;
        right: -20px;
        top: 50%;
        transform: translateY(-90%);
        padding: 2px 6px;
    }

    .filter-checkbox {
        margin-right: 6px;
    }

    .custom-select-container {
        position: relative;
        display: inline-block;
        width: 240px;
        height: 38px;
    }

    .final-label-select {
        width: 100%;
        height: 100%;
        padding: 0.25em 0.75em;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.25rem;
        border: none;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        text-align: center;
        cursor: pointer;
        color: #fff;
        background-clip: padding-box;
    }

    .custom-select-container .custom-arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        font-size: 0.9em;
        color: inherit;
    }

    .badge-label {
        display: inline-block;
        padding: 0.25em 0.75em;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.25rem;
        min-width: 240px;
        text-align: center;
        height: 38px;
        line-height: 30px;
    }

    #logTerminal {
        background-color: #1e1e1e;
        color: #00ff00;
        font-family: monospace;
        font-size: 0.85rem;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        border-radius: 5px;
        white-space: pre-wrap;
    }

    [data-label-value="CONTRADICTION"], .final-label-select option[value="CONTRADICTION"] { background-color: #dc3545; color: #fff; }
    [data-label-value="CULTURAL_DISCREPANCY"], .final-label-select option[value="CULTURAL_DISCREPANCY"] { background-color: #ffc107; color: #212529; }
    [data-label-value="NOT_ENOUGH_INFO"], .final-label-select option[value="NOT_ENOUGH_INFO"] { background-color: #17a2b8; color: #fff; }
    [data-label-value="NO_DISCREPANCY"], .final-label-select option[value="NO_DISCREPANCY"] { background-color: #28a745; color: #fff; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.topic-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });
    
    document.querySelectorAll('.dataset-header').forEach(function(header){
        header.addEventListener('click', function(){
            var contentId = header.getAttribute('aria-controls');
            var content = document.getElementById(contentId);
            if (!content) return;

            var expanded = header.getAttribute('aria-expanded') === 'true';
            if (expanded) {
                content.style.display = 'none';
                header.setAttribute('aria-expanded', 'false');
                var chev = header.querySelector('.chev');
                if (chev) chev.style.transform = '';
            } else {
                content.style.display = 'block';
                header.setAttribute('aria-expanded', 'true');
                var chev = header.querySelector('.chev');
                if (chev) chev.style.transform = 'rotate(90deg)';
            }
        });
    });
});
</script>

<script>
function plotTopicDistributions(documents) {
    documents.forEach(doc => {
        const canvas = document.getElementById(`chart-doc-${doc.doc_id}`);
        if (!canvas) {
            console.warn(`No canvas found for doc_id ${doc.doc_id}`);
            return;
        }

        new Chart(canvas, {
            type: 'pie',
            data: {
                labels: doc.topic_distribution.map((_, i) => `Topic ${i}`),
                datasets: [{
                    data: doc.topic_distribution,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', 
                        '#4BC0C0', '#9966FF', '#FF9F40', '#66FF66'
                    ]
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12 }
                    }
                }
            }
        });
    });
}
</script>


<script>
const topicColors = [
    '#FF6384', '#36A2EB', '#FFCE56',
    '#4BC0C0', '#9966FF', '#FF9F40',
    '#66FF66', '#FF6666', '#6699FF', '#99FF99'
];

class MINDInterface {
    constructor() {
        this.datasetItems = document.querySelectorAll('.dataset-item');
        this.modeSelectors = document.querySelectorAll('.mode-selectors');
        this.form = document.getElementById('mind-number-form');
        this.numberInput = document.getElementById('numberInput');
        this.topicButtons = document.querySelectorAll('.topic_button') ?? [];
        this.listViewBtn = document.getElementById('list-view-btn');
        this.graphViewBtn = document.getElementById('graph-view-btn');
        this.listView = document.getElementById('topic-list-view');
        this.graphView = document.getElementById('topic-graph-view');

        console.log(this.listView)

        this.fetchMindStatus();
        this.initEventListeners();
        this.initCarouselControls();
    }

    initEventListeners() {
        // Dataset selection
        this.datasetItems.forEach(item => {
            item.addEventListener('click', () => {
                const datasetName = item.getAttribute("dataset-tm");
                this.handleDatasetSelection(datasetName);
            });
        });

        // Form submission
        if (this.form) {
            this.form.addEventListener('submit', (e) => {
                e.preventDefault();
                const value = parseInt(this.numberInput.value, 10);
                if (!isNaN(value)) {
                    this.handleSubmitNumber(value);
                }
            });
        }

        // Mode selectors
        this.modeSelectors.forEach(selector => {
            selector.addEventListener('click', (e) => {
                e.preventDefault();
                const instruction = 'Analyze contradictions';

                const checkboxes = document.querySelectorAll('.topic-checkbox');
    
                const selected = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);

                if (selected.length < 1) {
                    alert('Select at least 1 topic.');
                    return;
                }

                const sampleSizeInput = document.getElementById('sampleSizeInput').value

                if (sampleSizeInput < 1) {
                    alert('Sample Size must be greater than 0.');
                    return;
                }
                
                const topics = selected.join(',');
                const TM = checkboxes[0].getAttribute("TM-name");
                this.handleInstruction(instruction, topics, TM, sampleSizeInput)
            });
        });
        // Topic buttons
        if (this.topicButtons) {
            console.log("Initializing topic buttons");
            this.initTopicButtons();
        }
        this.form.addEventListener('submit', this.handleFormSubmit.bind(this));

        if(this.listViewBtn){
            this.listViewBtn.addEventListener('click', (e) => {
                console.log("List view button clicked");
                e.preventDefault();
                console.log("listView is:", this.listView);
                this.listView.classList.remove('d-none');
                this.graphView.classList.add('d-none');
                this.listViewBtn.classList.add('active-view');
                this.graphViewBtn.classList.remove('active-view');
            });
        }

        if(this.graphViewBtn){
            this.graphViewBtn.addEventListener('click', (e) => {
                console.log("Graph view button clicked");
                e.preventDefault();
                this.listView.classList.add('d-none');
                this.graphView.classList.remove('d-none');
                this.graphViewBtn.classList.add('active-view');
                this.listViewBtn.classList.remove('active-view');


                if (!this.graphView.dataset.loaded) {
                    this.loadPyLDAvisGraph();
                    this.graphView.dataset.loaded = "true";
                }
            });
        }
    }
    initTopicButtons() {
    this.topicButtons.forEach(button => {
        button.addEventListener('click', () => {
            const topicId = button.dataset.topicId;
            this.handleTopicClick(topicId);
            this.loadTopicDocuments(topicId); 
        });
    });
    }
    loadPyLDAvisGraph() {
        fetch('/get_pyldavis')
            .then(res => res.json())
            .then(visData => {
                const visContainer = document.createElement('div');
                visContainer.id = 'pyldavis-container';
                document.getElementById('topic-graph-view').innerHTML = '';
                document.getElementById('topic-graph-view').appendChild(visContainer);

                // Render PyLDAvis inside the container
                // "ldavis" is the JS namespace exposed by the PyLDAvis JS lib
                LDAvis.load(visData, '#pyldavis-container');
            })
            .catch(err => console.error("Error loading PyLDAvis data:", err));
    }
    initCarouselControls() {
        const carousel = document.getElementById('document-carousel');
        const prevBtn = document.getElementById('prev-doc');
        const nextBtn = document.getElementById('next-doc');
        // const returnBtn = document.getElementById('return-btn');

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                $('#document-carousel').carousel('prev'); // Bootstrap's carousel function
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                $('#document-carousel').carousel('next');
            });
        }
    }

    handleFormSubmit(event) {
        event.preventDefault(); // Stop default form submission

        const n_samples = this.numberInput.value;

        fetch('/submit_analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken?.() || '', // if needed
            },
            body: JSON.stringify({
                n_samples: parseInt(n_samples, 10)
            })
        })
        .then(res => {
            if (!res.ok) throw new Error("Failed to submit analysis");
            return res.text(); // or .json() depending on your backend
        })
        .then(data => {
            console.log("Analysis submitted:", data);
            // Optional: Redirect, flash a message, reload UI
            window.location.reload();
        })
        .catch(err => {
            console.error("Submission error:", err);
            alert("An error occurred while submitting the analysis.");
        });
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

    loadTopicDocuments(topicId) {
        fetch('/topic_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken()
            },
            body: JSON.stringify({ topic_id: topicId })
        })
        .then(res => res.json())
        .then(data => {
            console.log("Topic documents data:", data);
            if (data.topic_documents && Array.isArray(data.topic_documents)) {
                this.renderCarousel(data.topic_documents);
            } else {
                console.error("Error loading documents", data);
            }
        })
        .catch(err => console.error("Error fetching topic documents:", err));
    }

    fetchMindStatus() {
        fetch('http://localhost:93/status') 
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch status");
                }
                return response.json();
            })
            .then(data => {
                this.state = data.state; 
                console.log("MIND status retrieved:", this.state);
            })
            .catch(error => {
                console.error("Error fetching MIND status:", error);
            });
    }

    fetchInstructions() {
        return fetch('/get_instruction')
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch instructions");
                }
                return response.json();
            })
            .then(data => {
                this.lastInstruction = data.instruction; 
                console.log("Instructions retrieved:", data);
            })
            .catch(error => {
                console.error("Error fetching instructions:", error);
            });
    }


    getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrf_token='))
            ?.split('=')[1];
        return cookieValue || '';
    }

    renderCarousel(documents) {
        const carouselContainer = document.getElementById('carousel-inner');
        const topicListCard = document.getElementById('topic-list-card');
        const carouselCard = document.getElementById('document-carousel-card');

        // Clear previous content
        carouselContainer.innerHTML = '';

        documents.forEach((doc, index) => {
            const activeClass = index === 0 ? 'active' : '';

            carouselContainer.innerHTML += `
                <div class="carousel-item ${activeClass}">
                    <div class="card shadow-sm border-0">
                        <div class="row g-0 align-items-center">
                            
                            <!-- Document text -->
                            <div class="col-md-8 p-3">
                                <div class="doc-text" style="max-height: 300px; overflow-y: auto;">
                                    <p class="mb-0">${doc.raw_text || 'No content available'}</p>
                                </div>
                            </div>

                            <!-- Topic distribution chart -->
                            <div class="col-md-4 p-3 text-center">
                                <h6 class="text-muted mb-2">Topic Distribution</h6>
                                <canvas id="chart-doc-${doc.doc_id}" style="max-width: 100%; height: auto;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        // Show carousel, hide topic list
        topicListCard.classList.add('d-none');
        carouselCard.classList.remove('d-none');

        // Re-initialize Bootstrap carousel
        $('#document-carousel').carousel(0);

        // Plot charts for each document
        documents.forEach(doc => {
            const ctx = document.getElementById(`chart-doc-${doc.doc_id}`);
            if (ctx && doc.topic_distribution) {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: doc.topic_distribution.map((_, i) => `Topic ${i}`),
                        datasets: [{
                            data: doc.topic_distribution,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', 
                                '#4BC0C0', '#9966FF', '#FF9F40', '#66FF66'
                            ]
                        }]
                    },
                    options: {
                        responsive: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { boxWidth: 12 }
                            }
                        }
                    }
                });
            }
        });
    }


    handleDatasetSelection(datasetName) {
        console.log("Selected option:\n", datasetName);

        fetch('/detection_topickeys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken?.() || ''
            },
            body: JSON.stringify(datasetName)
        })
        .then(res => {
            if (!res.ok) throw new Error("Backend error");
            return res.json();
        })
        .then(data => {
            window.location.href = data.redirect;
        })
        .catch(err => console.error("Dataset selection error:", err));
    }


    handleInstruction(instruction, topics, TM, sample_size) {
        console.log("Selected instruction:", instruction);
        const data = { "instruction": instruction, "topics": topics, "TM": TM, "sample_size": sample_size };

        const selector = document.querySelector(`#analyze_contradictions`);
        if (!selector) {
            console.error("Selector not found!");
            return;
        }

        selector.style.pointerEvents = 'none';
        selector.style.opacity = '0.6';
        selector.classList.add('disabled');

        const originalHTML = selector.innerHTML;
        selector.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Waiting...
        `;

        $("#logTerminal").empty();

        console.log(data);
        fetch('/mode_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken() 
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (res.ok) {
                window.location.href = `/detection_results?TM=${encodeURIComponent(TM)}&topics=${encodeURIComponent(topics)}`;
            } else {
                console.error("Error al recibir respuesta del backend");
            }
        })
        .catch(err => console.error("Dataset selection error:", err))
        .finally(() => {
            selector.style.pointerEvents = 'auto';
            selector.style.opacity = '1';
            selector.classList.remove('disabled');
            selector.innerHTML = originalHTML;
        });
        // setTimeout(() => {
        //     window.location.reload();
        // }, 1000); // Adjust the timeout as needed
    }

    async handleTopicClick(topicId) {
        await this.fetchInstructions(); 
        console.log("Selected topic:", topicId);
        console.log("Last instruction:", this.lastInstruction);
        if (this.lastInstruction === 'Explore topics') {
            fetch('/topic_selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken() 
                },
                body: JSON.stringify({ topic_id: topicId })
            })
            .then(res => res.json())
            .then(data => {
                console.log("Backend response:", data);
                if (data.topic_documents) {
                    plotTopicDistributions(data.topic_documents);
                }
            }).catch(err => console.error("Topic selection error:", err));
        }
        else if (this.lastInstruction === 'Analyze contradictions') { // Not done yet
            fetch('/analyze_topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken() // if using Flask-WTF/CSRF
                },
                body: JSON.stringify({ topic_id: topicId })
            })
            .then(res => res.json())
            .then(data => {
                console.log("Backend response:", data);
                if (data.topic_documents) {
                    plotTopicDistributions(data.topic_documents);
                }
            })
            .catch(err => console.error("Topic analysis error:", err));
        } else {
            console.error("Invalid instruction for topic selection:", this.lastInstruction);
            return;
        }

    }

}

// Instantiate when DOM is fully loaded
document.addEventListener('DOMContentLoaded', () => {
    console.log("MINDInterface initialized");
    const mindInterface = new MINDInterface();
    // const socket = new WebSocket(`ws://${window.location.host}/ws`);
    
});

</script>

{% if csrf_token %}
<script>
    document.cookie = "csrf_token={{ csrf_token }}";
</script>
{% endif %}
<style>
.hover-text-primary:hover {
    color: #007bff;
    cursor: pointer;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = $('#docModal');
    const modalTitle = modal.find('.modal-title');
    const modalBody = modal.find('.modal-body');

    document.querySelectorAll('.view-doc-link').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();

            const docId = this.getAttribute('data-doc-id');
            const docContent = this.getAttribute('data-doc-content');

            modalTitle.text(`Document ${docId}`);
            modalBody.html(`<pre style="white-space: pre-wrap;">${docContent}</pre>`);

            modal.modal('show');
        });
    });
});
</script>

<!-- Load Chart.js (you can put this in your base template head) -->

<script>
async function loadTopicDistributions(topicId) {
    try {
        // Fetch data from your /topic_selection endpoint
        const response = await fetch('/topic_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ topic_id: topicId })
        });
        console.log(topicId);
        const data = await response.json();
        const documents = data.topic_documents;

        documents.forEach(doc => {
            const ctx = document.getElementById(`chart-doc-${doc.doc_id}`);
            if (!ctx) return; 

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: doc.topic_distribution.map((_, i) => `Topic ${i}`),
                    datasets: [{
                        label: 'Topic Probability',
                        data: doc.topic_distribution,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        });
    } catch (err) {
        console.error("Error loading topic distributions:", err);
    }
}

</script>

<script src="https://cdn.jsdelivr.net/gh/bmabey/pyLDAvis@master/pyLDAvis/js/ldavis.js"></script>


{% endblock %}


