{% extends "base.html" %}
{% block title %}Detection{% endblock %}

{% block content %}

{% if status in ['idle', 'initializing'] %}
    {% if dataset_detection %}
    <h1>MIND Cultural discrepancy detection</h1>
    {% elif topic_keys %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0" id="TopicModel-h3" TM-name="{{ topic_keys['topics'][0]['TM_name'] }}">
            Select topics from the Topic Model "{{ topic_keys["topics"][0]["TM_name"] if topic_keys["topics"] else '' }}"
        </h3>

        <div class="btn-group" role="group" aria-label="Visual/Text toggle">
            <button type="button" class="btn btn-primary active" id="btn-visual" data-no-warning>Visual</button>
            <button type="button" class="btn btn-outline-primary" id="btn-text" data-no-warning>Text</button>
        </div>
    </div>
    {% endif %}
{% endif %}

<div class="jumbotron" id='jumbotron-detection' style="height: 60vh; overflow-y: auto; padding: 2rem;">
    {% if status in ['idle', 'initializing'] %}        
        {% if dataset_detection %}
            <p class="lead">Start a session by selecting a dataset and a topic model associated:</p>
            <div class="dataset-accordion">
                {% for dataset, topicmodel_list in dataset_detection.items() %}
                <div class="dataset-group mb-3 border rounded-2 shadow-sm">

                    <div class="dataset-header list-group-item hover-text-primary fw-bold bg-light" 
                        role="button"
                        aria-expanded="false"
                        aria-controls="content-{{ loop.index }}"
                        style="cursor:pointer; border:none;">
                        Dataset: {{ dataset }}
                        <span class="chev" aria-hidden="true" style="float:right; transition: transform .2s;">▸</span>
                    </div>

                    <ul id="content-{{ loop.index }}" class="list-group dataset-list" 
                        style="display:none; background-color:#f8f9fa; margin:0; border-top:1px solid #ddd;">
                        {% for tm in topicmodel_list %}
                        <li class="list-group-item dataset-item hover-text-primary dataset-entry" 
                            style="background-color:#f0f0f0; border:none; border-bottom:1px solid #e0e0e0;"
                            dataset-tm='{ "dataset_name": "{{ dataset }}", "topic_model": "{{ tm }}" }'>
                            <a class="dataset-link d-block px-2 py-1">
                                Topic Model: {{ tm }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>

        {% elif topic_keys %}
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <!-- Option 1: Visual -->
        <div id="topicVis" style="display: block; width: 100%; height: 100%; overflow: hidden;"></div>

        <!-- Option 2: Keywords only -->
        <div class="topic-accordion" style="display: none; overflow-y: auto; overflow-x: hidden;">

            {% for topic in topic_keys["topics"] %}
            <div class="topic-group mb-3 border rounded-2 shadow-sm">

                <!-- Header: Checkbox + Topic title -->
                <div class="dataset-header topic-header list-group-item hover-text-primary fw-bold bg-light d-flex align-items-center justify-content-between"
                    role="button"
                    aria-expanded="false"
                    aria-controls="topic-content-{{ loop.index }}"
                    style="cursor: pointer; border: none;">

                    <div class="d-flex align-items-center" style="margin-left: 15px;">
                        <input type="checkbox"
                            class="form-check-input topic-checkbox"
                            name="topic_select"
                            value="{{ topic.id }}"
                            style="cursor: pointer; margin-right: 10px; margin-top: 0; transform: scale(1.1); accent-color: #0d6efd;">
                        <label class="mb-0">Topic {{ topic.id }}</label>
                    </div>

                    <div class="d-flex align-items-center">
                        <span class="chev" aria-hidden="true" style="transition: transform .2s;">▸</span>
                    </div>

                </div>

                <!-- Topic keywords -->
                <ul id="topic-content-{{ loop.index }}" 
                    class="list-group topic-list"
                    style="display: none; background-color: #f8f9fa; margin: 0; border-top: 1px solid #ddd;">

                    {% for lang in ['EN', 'ES'] %}
                        {% if topic['keywords_' + lang] is defined %}
                        <li class="list-group-item topic-item"
                            style="background-color: #f0f0f0; border: none; border-bottom: 1px solid #e0e0e0;">
                            <strong>{{ lang }}:</strong> {{ topic['keywords_' + lang] | join(' ') }}
                        </li>
                        {% endif %}
                    {% endfor %}

                </ul>

            </div>
            {% endfor %}
        </div>

        <script>
        document.addEventListener("DOMContentLoaded", function() {
            const topics = {{ topic_keys | tojson }};
            
            window.currentView = "visual";
            window.currentVisibleTopics = [];

            const btnVisual = document.getElementById("btn-visual");
            const btnText = document.getElementById("btn-text");
            const topicVis = document.getElementById("topicVis");
            const topicAccordion = document.querySelector(".topic-accordion");

            function drawTopicVis(topicsData) {
                const container = topicVis;
                container.innerHTML = "";

                const width = container.clientWidth;
                const height = container.clientHeight;

                const svg = d3.select(container)
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

                svg.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", width)
                    .attr("height", height)
                    .style("fill", "rgba(255,255,255,0.6)");

                const margin = {top: 20, right: 20, bottom: 40, left: 40};
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;

                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Scales
                const xExtent = d3.extent(topics.topics, d => d.x);
                const yExtent = d3.extent(topics.topics, d => d.y);

                const xScale = d3.scaleLinear().domain(xExtent).range([0, innerWidth]);
                const yScale = d3.scaleLinear().domain(yExtent).range([innerHeight, 0]);

                const xMid = (xExtent[0] + xExtent[1]) / 2;
                const yMid = (yExtent[0] + yExtent[1]) / 2;

                // X Axis
                g.append("g")
                .attr("transform", `translate(0, ${yScale(yMid)})`)
                .call(d3.axisBottom(xScale).ticks(5));

                // Y Axis
                g.append("g")
                .attr("transform", `translate(${xScale(xMid)},0)`)
                .call(d3.axisLeft(yScale).ticks(5));

                const sizeExtent = d3.extent(topicsData, d => d.size);
                const sizeScale = d3.scaleLinear().domain(sizeExtent).range([20, 60]);
                const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                    .domain(topicsData.map(d => d.id));

                // Tooltip
                const tooltip = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip-topic")
                    .style("position", "absolute")
                    .style("padding", "8px")
                    .style("background-color", "rgba(0,0,0,0.7)")
                    .style("color", "#fff")
                    .style("border-radius", "4px")
                    .style("pointer-events", "none")
                    .style("opacity", 0);

                // Topic Bubbles
                const nodes = g.selectAll("g.node")
                    .data(topicsData)
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .attr("transform", d => `translate(${xScale(d.x)},${yScale(d.y)})`)
                    .style("cursor", "pointer")
                    .on("mousemove", function(event, d) {
                        tooltip
                            .style("opacity", 1)
                            .html(`
                                <strong>Topic ${d.id}</strong><br>
                                <b>EN:</b> ${d.keywords_EN?.join(", ") || "-"}<br>
                                <b>ES:</b> ${d.keywords_ES?.join(", ") || "-"}
                            `)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY + 15) + "px");
                    })
                    .on("mouseout", () => tooltip.style("opacity", 0))
                    .on("click", function(event, d) {
                        if (window.currentVisibleTopics.includes(d.id)) {
                            window.currentVisibleTopics = window.currentVisibleTopics.filter(x => x !== d.id);
                            d3.select(this).select("circle").style("stroke", "none");
                        } else {
                            window.currentVisibleTopics.push(d.id);
                            d3.select(this).select("circle")
                                .style("stroke", "rgba(255,0,0,0.8)")
                                .style("stroke-width", 2);
                        }
                        console.log("Tópicos seleccionados:", [...window.currentVisibleTopics]);
                    });

                const normPos = d => ((d.x - xExtent[0])/(xExtent[1]-xExtent[0]) + (d.y - yExtent[0])/(yExtent[1]-yExtent[0])) / 2;

                // Color Bubble
                nodes.append("circle")
                    .attr("r", d => sizeScale(d.size))
                    .style("fill", d => d3.interpolateViridis(normPos(d)))
                    .style("opacity", 0.85)
                    .each(function(d) {
                        if (window.currentVisibleTopics.includes(d.id)) {
                            d3.select(this)
                            .style("stroke", "rgba(255,0,0,0.8)")
                            .style("stroke-width", 2);
                        }
                    });

                nodes.select("circle")
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", sizeScale(d.size) * 1.1)
                        .style("fill", "rgba(255,0,0,0.5)");
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", sizeScale(d.size))
                        .style("fill", d => d3.interpolateViridis(normPos(d)));
                    });

                nodes.append("text")
                    .text(d => d.id)
                    .attr("text-anchor", "middle")
                    .attr("alignment-baseline", "middle")
                    .style("fill", "#fff")
                    .style("font-size", "12px")
                    .style("pointer-events", "none");
            }

            drawTopicVis(topics.topics);

            // Toggle Visual / Text
            btnVisual.addEventListener("click", () => {
                window.currentView = "visual";
                topicVis.style.display = "block";
                topicAccordion.style.display = "none";

                btnVisual.classList.add("active", "btn-primary");
                btnVisual.classList.remove("btn-outline-primary");
                btnText.classList.remove("active", "btn-primary");
                btnText.classList.add("btn-outline-primary");

                drawTopicVis(topics.topics);
            });

            btnText.addEventListener("click", () => {
                window.currentView = "text";
                topicVis.style.display = "none";
                topicAccordion.style.display = "block";

                btnText.classList.add("active", "btn-primary");
                btnText.classList.remove("btn-outline-primary");
                btnVisual.classList.remove("active", "btn-primary");
                btnVisual.classList.add("btn-outline-primary");
            });

            window.addEventListener("resize", () => {
                if (window.currentView === "visual") {
                    drawTopicVis(topics.topics);
                }
            });
        });
        </script>
        {% else %}
            <p class="lead">No datasets found or error loading datasets.</p>
        {% endif %}

    {% elif status == 'completed' %}
        {% if result_mind and result_columns %}
            <!-- Loading overlay -->
            <div id="loadingOverlay" style="
                position: fixed;
                top:0; left:0;
                width:100%; height:100%;
                background: rgba(255,255,255,0.9);
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.5rem;
                color: #333;
            ">
                <div>
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div style="margin-top:10px;">Loading, please wait...</div>
                </div>
            </div>

            <script>
            window.onload = function() {
                var overlay = document.getElementById('loadingOverlay');
                setTimeout(function() {
                    overlay.style.display = 'none';
                }, 1000);
            };
            </script>

            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
            <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">

            <!-- Table Result MIND -->
            <table id="resultsTable" class="table table-striped table-hover table-bordered align-middle">
                <thead class="thead-light">
                    <tr>
                        {% for col in result_columns %}
                            {% if col in ['label', 'final_label'] %}
                            <th class="th-with-filter" style="position: relative;">
                                {{ col }}
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm filter-icon-btn filter-btn"
                                            type="button" id="dropdown{{ loop.index0 }}"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                            data-column="{{ col }}">
                                        <i class="bi bi-droplet"></i>
                                    </button>
                                    <div class="dropdown-menu p-2" aria-labelledby="dropdown{{ loop.index0 }}"
                                        style="max-height: 200px; overflow-y: auto;">
                                        <!-- All -->
                                        <label class="dropdown-item">
                                            <input type="checkbox" class="filter-checkbox" data-value="ALL" checked> All
                                        </label>
                                        {% set label_options = ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY'] %}
                                        {% for val in label_options %}
                                        <label class="dropdown-item">
                                            <input type="checkbox" class="filter-checkbox" data-value="{{ val }}" checked> {{ val }}
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </th>
                            {% else %}
                            <th>{{ col }}</th>
                            {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                {% for row in result_mind %}
                <tr>
                    {% for col in result_columns %}
                        {% if col == 'final_label' %}
                        <td>
                            <div class="custom-select-container">
                                <select class="final-label-select">
                                    {% set options = ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY'] %}
                                    {% for opt in options %}
                                        <option value="{{ opt }}" {% if row['final_label'] == opt %}selected{% endif %}>{{ opt }}</option>
                                    {% endfor %}
                                </select>
                                <span class="custom-arrow">▼</span>
                            </div>
                        </td>
                        {% elif col == 'label' %}
                        <td>
                            <span class="badge-label" data-label-value="{{ row[col] }}">{{ row[col] }}</span>
                        </td>
                        {% else %}
                        <td class="truncated">
                            {% if row[col] != None %}
                                {% set words = row[col].split() %}
                                {% if words|length > 50 %}
                                    {{ words[:50]|join(' ') }}...
                                {% else %}
                                    {{ row[col] }}
                                {% endif %}
                            {% else %}
                                {{ row[col] }}
                            {% endif %}
                        </td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-warning text-center mt-5">
                <strong>No data available.</strong>
            </div>
        {% endif %}
    {% else %}
    <p>No datasets available.</p>
    {% endif %}
</div>

<div class="modal fade" id="docModal" tabindex="-1" role="dialog" aria-labelledby="docModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="docModalLabel">Document Content</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Loading document content...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Alert End Process Analysis Discrepancy -->
<div id="exitModal" class="exit-modal" style="display: none;" tabindex="-1" role="dialog" aria-labelledby="exitModalLabel" aria-hidden="true">
    <div class="exit-modal-dialog" role="document">
        <div class="exit-modal-content p-3">
            <div class="exit-modal-header">
                <h5 class="exit-modal-title" id="exitModalLabel">Warning</h5>
                <button type="button" class="exit-modal-close" aria-label="Close" id="exitModalClose">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="exit-modal-body">
                <p>If you leave this page, discrepancy analysis will stop.</p>
            </div>
            <div class="exit-modal-footer">
                <button type="button" id="exitYes" class="exit-modal-btn exit-modal-btn-danger">Leave page</button>
                <button type="button" id="exitNo" class="exit-modal-btn exit-modal-btn-secondary">Stay here</button>
            </div>
        </div>
    </div>
</div>

<script>
let shouldWarn = false;
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    window.addEventListener("beforeunload", e => {
        if (!shouldWarn) return;
        e.preventDefault();
        e.returnValue = "";
    });

    document.addEventListener("click", e => {
        const el = e.target.closest("a, button[data-navigate]");
        if (!el) return;

        if (!shouldWarn) return;
        if (el.hasAttribute("data-no-warning")) return;

        e.preventDefault();
        const url = el.href || el.dataset.navigate;
        showExitModal(url);
    });

    const modal = document.getElementById("exitModal");
    const exitYes = document.getElementById("exitYes");
    const exitNo = document.getElementById("exitNo");
    const exitClose = document.getElementById("exitModalClose");

    function showExitModal(url) {
        modal.style.display = "flex";
        requestAnimationFrame(() => {
            modal.classList.add("show");
        });

        exitYes.onclick = () => {
            shouldWarn = false;
            window.removeEventListener("beforeunload", () => {});
            window.location.href = url;
        };

        exitNo.onclick = exitClose.onclick = () => {
            modal.classList.remove("show");
            modal.addEventListener('transitionend', () => {
                modal.style.display = "none";
            }, { once: true });
        };
    }
});
</script>

{% if result_mind and result_columns %}
<div id="datatable-controls-1" class="d-flex align-items-center mb-2">
    <!-- Filter Columns -->
    <button class="btn btn-light dropdown-toggle" type="button" id="columnFilterBtn" style="margin-right: 15px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Filter Columns
    </button>
    <div class="dropdown-menu p-3" aria-labelledby="columnFilterBtn" style="max-height: 250px; overflow-y: auto;">
        <div class="form-check">
            <input class="form-check-input column-all" type="checkbox" value="ALL" id="columnAll">
            <label class="form-check-label" for="columnAll">All</label>
        </div>
        {% for col in result_columns %}
        <div class="form-check">
            <input class="form-check-input column-checkbox" type="checkbox" value="{{ col }}" id="column_{{ loop.index0 }}" checked>
            <label class="form-check-label" for="column_{{ loop.index0 }}">{{ col }}</label>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var defaultVisibleCols = ['question','anchor_passage','comparison_passage','anchor_answer','comparison_answer','label','final_label','reason'];

    document.querySelectorAll('.column-checkbox').forEach(function(checkbox) {
        var colValue = checkbox.value;
        if (colValue === 'ALL') {
            checkbox.checked = true;
        } else {
            checkbox.checked = defaultVisibleCols.includes(colValue);
        }
    });
});
</script>

<div id="datatable-controls-2" class="d-flex justify-content-between mb-3">
    <button id="exportXlsxBtn" class="btn btn-success mb-3">
        <i class="bi bi-download"></i> Save & Download XLSX
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var defaultVisibleCols = ['question','anchor_passage','comparison_passage','anchor_answer','comparison_answer','label','final_label','reason'];
    var columns = {{ columns_json|safe }};
    var allResultCols = {{ result_columns|tojson|safe }};
    var nonOrderable = {{ non_orderable_indices|safe }};

    var visibleIndices = [];
    for (var i = 0; i < columns.length; i++) {
        if (defaultVisibleCols.includes(columns[i].name)) visibleIndices.push(i);
    }
    var hiddenIndices = [];
    for (var i = 0; i < columns.length; i++) {
        if (!visibleIndices.includes(i)) hiddenIndices.push(i);
    }

    var table = $('#resultsTable').DataTable({
        pageLength: 10,
        columns: columns,
        orderCellsTop: true,
        autoWidth: false,
        columnDefs: [
            { orderable: false, targets: nonOrderable },
        ],
        language: {
            "zeroRecords": "No records were found",
            "info": "Showing _START_ to _END_ from _TOTAL_ records",
            "infoEmpty": "Showing 0 records",
            "infoFiltered": ""
        }
    });

    var possibleValues = {
        'label': ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY'],
        'final_label': ['CONTRADICTION','CULTURAL_DISCREPANCY','NOT_ENOUGH_INFO','NO_DISCREPANCY']
    };

    var activeFilters = {
        'label': possibleValues['label'].slice(),
        'final_label': possibleValues['final_label'].slice()
    };

    function applyVisibleColumns(visibleColumns) {
        table.columns().every(function(index) {
            var colName = this.settings()[0].aoColumns[index].name;
            this.visible(visibleColumns.includes(colName));
        });
    }

    var visibleColumns = $('.column-checkbox:checked').map(function() {
        return $(this).val();
    }).get();

    if (visibleColumns.length === 0) {
        visibleColumns = allResultCols.filter(c => defaultVisibleCols.includes(c));
    }

    if (visibleColumns.length === allResultCols.length) {
        $('#columnAll').prop('checked', true);
    } else {
        $('#columnAll').prop('checked', false);
    }

    applyVisibleColumns(visibleColumns);

    $('body').on('change', '.column-all', function() {
        var checked = $(this).prop('checked');
        if (checked) {
            $('.column-checkbox').prop('checked', true);
            visibleColumns = allResultCols.slice();
        } else {
            $('.column-checkbox').prop('checked', false);
            visibleColumns = [];
        }
        applyVisibleColumns(visibleColumns);
    });

    $('body').on('change', '.column-checkbox', function() {
        visibleColumns = $('.column-checkbox:checked').map(function() {
            return $(this).val();
        }).get();

        if (visibleColumns.length === allResultCols.length) {
            $('#columnAll').prop('checked', true);
        } else {
            $('#columnAll').prop('checked', false);
        }

        applyVisibleColumns(visibleColumns);
    });
    
    function updateColors() {
        // final_label
        $('.final-label-select').each(function() {
            var value = $(this).val();
            var bgColor, textColor;
            switch(value) {
                case 'CONTRADICTION': bgColor = '#dc3545'; textColor = '#fff'; break;
                case 'CULTURAL_DISCREPANCY': bgColor = '#ffc107'; textColor = '#212529'; break;
                case 'NOT_ENOUGH_INFO': bgColor = '#17a2b8'; textColor = '#fff'; break;
                case 'NO_DISCREPANCY': bgColor = '#28a745'; textColor = '#fff'; break;
                default: bgColor = '#6c757d'; textColor = '#fff';
            }
            $(this).css({ 'background-color': bgColor, 'color': textColor });
            $(this).siblings('.custom-arrow').css('color', textColor);
        });

        // label
        $('.badge-label').each(function() {
            var value = $(this).data('label-value');
            var bgColor, textColor;
            switch(value) {
                case 'CONTRADICTION': bgColor = '#dc3545'; textColor = '#fff'; break;
                case 'CULTURAL_DISCREPANCY': bgColor = '#ffc107'; textColor = '#212529'; break;
                case 'NOT_ENOUGH_INFO': bgColor = '#17a2b8'; textColor = '#fff'; break;
                case 'NO_DISCREPANCY': bgColor = '#28a745'; textColor = '#fff'; break;
                default: bgColor = '#6c757d'; textColor = '#fff';
            }
            $(this).css({ 'background-color': bgColor, 'color': textColor });
        });
    }

    // Colors span label final_label
    updateColors();
    $('#resultsTable').on('draw.dt', function() {
        updateColors();
    });

    $('body').on('change', '.final-label-select', function() {
        updateColors();
        var row = $(this).closest('tr');
        table.row(row).invalidate().draw(false);
    });

    // Cols filter
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        for (var colName in activeFilters) {
            var selectedValues = activeFilters[colName];
            if (!selectedValues || selectedValues.length === 0) return false;

            var colIndex = table.column(colName + ":name").index();
            var cellNode = table.cell(dataIndex, colIndex).node();

            var cellValue;

            if (colName === 'final_label') {
                cellValue = $(cellNode).find('select.final-label-select').val();
            } else {
                var cellHtml = $(cellNode).html() || "";
                cellValue = cellHtml.replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
            }

            if (!selectedValues.includes(cellValue)) {
                return false;
            }
        }
        return true;
    });

    // User change value final_label
    $('body').on('change', '.final-label-select', function() {
        var row = $(this).closest('tr');
        var value = $(this).val();
        
        var table = $('#resultsTable').DataTable();
        table.row(row).invalidate().draw(false);

        activeFilters['final_label'] = table.rows().nodes().to$().find('.final-label-select').map(function() {
            return $(this).val();
        }).get();
    });

    // Filter checkbox label final_label
    $('body').on('click', '.filter-checkbox', function(e) {
        e.stopPropagation();

        var checkbox = $(this);
        var value = checkbox.data('value');
        var dropdown = checkbox.closest('.dropdown-menu');
        var btn = dropdown.siblings('.filter-btn');
        var colName = btn.data('column');
        var allCheckbox = dropdown.find('input.filter-checkbox[data-value="ALL"]');

        if (!activeFilters[colName]) activeFilters[colName] = [];

        if (value === "ALL") {
            if (checkbox.prop('checked')) {
                activeFilters[colName] = possibleValues[colName].slice();
                dropdown.find('input.filter-checkbox').prop('checked', true);
            } else {
                activeFilters[colName] = [];
                dropdown.find('input.filter-checkbox').prop('checked', false);
            }
        } else {
            if (checkbox.prop('checked')) {
                if (!activeFilters[colName].includes(value)) activeFilters[colName].push(value);
            } else {
                activeFilters[colName] = activeFilters[colName].filter(v => v !== value);
            }

            if (activeFilters[colName].length === possibleValues[colName].length) {
                allCheckbox.prop('checked', true);
            } else {
                allCheckbox.prop('checked', false);
            }
        }

        if (activeFilters[colName].length > 0) {
            btn.removeClass('btn-light').addClass('btn-primary');
        } else {
            btn.removeClass('btn-primary').addClass('btn-light');
        }

        table.draw();
    });

    $('body').on('click', '.dropdown-item', function(e) {
        e.stopPropagation();
    });

    $('.filter-checkbox').each(function() {
        var checkbox = $(this);
        var value = checkbox.data('value');
        var colName = checkbox.closest('.dropdown-menu').siblings('.filter-btn').data('column');
        if (value === "ALL") {
            checkbox.prop('checked', activeFilters[colName].length === possibleValues[colName].length);
        } else {
            checkbox.prop('checked', activeFilters[colName].includes(value));
        }
    });

    table.draw();

    $('#result');
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    var lengthDiv = $('#resultsTable_length');
    var label = lengthDiv.find('label');
    var select = label.find('select');

    label.contents().filter(function() {
        return this.nodeType === 3;
    }).remove();

    label.prepend('<span style="white-space: nowrap;">Show entries</span> ');

    label.css({
        display: 'flex',
        alignItems: 'center',
        gap: '5px',
        marginBottom: '0'
    });

    select.addClass('ml-2');

    $('#datatable-controls-1').append(lengthDiv);

    $('#datatable-controls-2').append(
        $('#resultsTable_info'),
        $('#resultsTable_paginate'),
        $('#exportXlsxBtn')
    );

    $('#resultsTable_filter').remove();

    document.getElementById('jumbotron-detection').style.marginBottom = '15px';
    document.getElementById('jumbotron-detection').style.marginTop = '-1rem';
    document.getElementById('jumbotron-detection').style.height = '68vh';
    document.getElementById('resultsTable_info').style.marginLeft = '10px';
    document.getElementById('resultsTable_length').style.marginLeft = 'auto';
});
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var table = $('#resultsTable').DataTable();

    $('#exportXlsxBtn').on('click', function() {
        exportTableToXLSX();
    });

    function exportTableToXLSX(filename = 'results_mind.xlsx') {
        var ws_data = [];

        var headers = {{ result_columns | tojson }};
        ws_data.push(headers);

        var columnVisibility = [];
        table.columns().every(function(idx) {
            columnVisibility[idx] = this.visible();
        });

        table.columns().visible(true, false);

        table.rows().nodes().each(function(tr) {
            var row_data = [];
            var $tr = $(tr);

            headers.forEach(function(colName) {
                var colIdx = table.column(colName + ":name").index();
                var $td = $tr.find('td').eq(colIdx);
                var cell;

                if ($td.find('select.final-label-select').length) {
                    cell = $td.find('select.final-label-select').val() || '';
                } else if ($td.find('.badge-label').length) {
                    cell = $td.find('.badge-label').data('label-value') || '';
                } else {
                    var cellHtml = $td.html() || '';
                    cell = cellHtml
                        .replace(/<br\s*\/?>/gi, '\n')
                        .replace(/<[^>]+>/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();
                }

                row_data.push(cell);
            });

            ws_data.push(row_data);
        });

        table.columns().every(function(idx) {
            this.visible(columnVisibility[idx], false);
        });
        table.draw(false);

        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

        var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        var blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

        var formData = new FormData(); formData.append('file', blob, filename);
        const urlParams = new URLSearchParams(window.location.search);
        formData.append('TM', urlParams.get('TM') || '');
        formData.append('topics', urlParams.get('topics') || '');

        fetch('/update_results', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => console.log(data))
        .catch(err => console.error("Error in XLSX:", err));

        XLSX.writeFile(wb, filename);
    }
});
</script>

{% elif topic_keys %}
<ul class="nav nav-pills mb-4 d-flex justify-content-between w-100" id="myTab" role="tablist">
    <!-- Config Pipeline MIND -->
    <li class="nav-item d-flex align-items-center">
        <a class="nav-link active" style="cursor: pointer;" data-toggle="modal" data-target="#configPipelineModalLabel" data-no-warning>
            Config Pipeline MIND
        </a>
    </li>

    <!-- Run Pipeline MIND -->
    <li class="nav-item d-flex align-items-center">
        <!-- Max input = ntopics -->
        <label for="numberInput" class="mr-2 mb-0">Sample Size: </label>
        <input type="number" class="form-control mr-2" id="sampleSizeInput" name="n_samples" placeholder="1" value="5" min="1" style="width: 100px;">
        <a class="nav-link mode-selectors active" id="analyze_contradictions" style="cursor: pointer;" data-toggle="tab" data-no-warning>Analyze Discrepancies</a>
        <a class="nav-link active" style="margin-left: 10px; cursor: pointer;" data-toggle="modal" data-target="#logModal" data-no-warning>
            Check Status
        </a>
    </li>
</ul>

<!-- Configuration Div Pipeline MIND -->
<div class="modal fade" id="configPipelineModalLabel" tabindex="-1" role="dialog" aria-labelledby="configPipelineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="configPipelineModalLabel">Configuration Pipeline MIND</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Configure the following values to analyze discrepancies:</p>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="llmSelect" class="me-2" style="width: 100px;">LLM:</label>
                    <select id="llmSelect" class="form-control flex-grow-1">
                        <option value="qwen2.5:72b">qwen2.5:72b</option>
                        <option value="llama3.2">llama3.2</option>
                        <option value="llama3.1:8b-instruct-q8_0">llama3.1:8b-instruct-q8_0</option>
                        <option value="qwen:32b">qwen:32b</option>
                        <option value="llama3.3:70b">llama3.3:70b</option>
                        <option value="qwen2.5:7b-instruct">qwen2.5:7b-instruct</option>
                        <option value="qwen3:32b">qwen3:32b</option>
                        <option value="llama3.3:70b-instruct-q5_K_M">llama3.3:70b-instruct-q5_K_M</option>
                        <option value="llama3:8b" selected>llama3:8b</option>
                    </select>
                </div>

                <div class="form-group mb-3 d-flex align-items-center">
                    <label for="methodSelect" class="me-2" style="width: 100px;">Method:</label>
                    <select id="methodSelect" class="form-control flex-grow-1">
                        <option value="ENN">ENN</option>
                        <option value="ANN">ANN</option>
                        <option value="TB-ENN" selected>TB-ENN</option>
                        <option value="TB-ANN">TB-ANN</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Pipeline MIND -->
<div class="modal fade" id="logModal" tabindex="-1" role="dialog" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalLabel">Pipeline Log</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="logTerminal"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const terminal = $("#logTerminal");

    $('#logModal').on('shown.bs.modal', function () {
        terminal.scrollTop(terminal[0].scrollHeight);
    });

    const evtSource = new EventSource("/stream_detection");

    evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const logLine = data.log;

        terminal.append(document.createTextNode(logLine + "\n"));
        terminal.scrollTop(terminal[0].scrollHeight);
    };

    evtSource.onerror = function(err) {
        console.error("SSE error:", err);
    };
});
</script>
{% endif %}

<style>
    .dataset-entry:hover {
        background-color: #e2e2e2 !important;
        transition: background-color 0.2s ease;
    }

    .dataset-entry:hover a {
        color: #007bff; 
        text-decoration: underline;
    }

    .jumbotron::-webkit-scrollbar {
        width: 8px;
    }
    
    .jumbotron::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 4px;
    }
    
    .jumbotron::-webkit-scrollbar-thumb:hover {
        background-color: #aaa;
    }

    .dataset-link {
        color: #000 !important;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .dataset-entry:hover .dataset-link {
        color: #007bff !important;
        text-decoration: underline;
    }

    th.th-with-filter {
        position: relative;
        padding-right: 32px !important;
        min-width: 240px;
        max-width: 240px;
        white-space: nowrap;
    }

    .filter-icon-btn {
        position: absolute;
        right: -20px;
        top: 50%;
        transform: translateY(-90%);
        padding: 2px 6px;
    }

    .filter-checkbox {
        margin-right: 6px;
    }

    .custom-select-container {
        position: relative;
        display: inline-block;
        width: 240px;
        height: 38px;
    }

    .final-label-select {
        width: 100%;
        height: 100%;
        padding: 0.25em 0.75em;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.25rem;
        border: none;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        text-align: center;
        cursor: pointer;
        color: #fff;
        background-clip: padding-box;
    }

    .custom-select-container .custom-arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        font-size: 0.9em;
        color: inherit;
    }

    .badge-label {
        display: inline-block;
        padding: 0.25em 0.75em;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.25rem;
        min-width: 240px;
        text-align: center;
        height: 38px;
        line-height: 30px;
    }

    #resultsTable {
        table-layout: fixed;
        width: max-content;
    }

    td.truncated {
        width: 250px;
        max-height: 120px;
        overflow: hidden;
        white-space: normal;
        word-wrap: break-word;
    }

    #logTerminal {
        background-color: #1e1e1e;
        color: #00ff00;
        font-family: monospace;
        font-size: 0.85rem;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        border-radius: 5px;
        white-space: pre-wrap;
    }

    .tooltip-topic {
        position: absolute;
        background: white;
        padding: 8px;
        border: 1px solid #aaa;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.15s ease;
        font-size: 14px;
        z-index: 1000;
    }

    .exit-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
        opacity: 0;
        transform: scale(0.9);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .exit-modal.show {
        opacity: 1;
        transform: scale(1);
    }

    .exit-modal-dialog {
        display: flex;
        flex-direction: column;
        max-width: 500px;
        width: 90%;
    }

    .exit-modal-content {
        border-radius: 8px;
        background: white;
        display: flex;
        flex-direction: column;
    }

    .exit-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
    }

    .exit-modal-body {
        padding: 1rem 0;
    }

    .exit-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 0.5rem;
        border-top: 1px solid #ddd;
    }

    .exit-modal-btn {
        min-width: 100px;
        padding: 0.375rem 0.75rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .exit-modal-btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .exit-modal-btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .exit-modal-close {
        background: none;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
    }

    [data-label-value="CONTRADICTION"], .final-label-select option[value="CONTRADICTION"] { background-color: #dc3545; color: #fff; }
    [data-label-value="CULTURAL_DISCREPANCY"], .final-label-select option[value="CULTURAL_DISCREPANCY"] { background-color: #ffc107; color: #212529; }
    [data-label-value="NOT_ENOUGH_INFO"], .final-label-select option[value="NOT_ENOUGH_INFO"] { background-color: #17a2b8; color: #fff; }
    [data-label-value="NO_DISCREPANCY"], .final-label-select option[value="NO_DISCREPANCY"] { background-color: #28a745; color: #fff; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.topic-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });
    
    document.querySelectorAll('.dataset-header').forEach(function(header){
        header.addEventListener('click', function(){
            var contentId = header.getAttribute('aria-controls');
            var content = document.getElementById(contentId);
            if (!content) return;

            var expanded = header.getAttribute('aria-expanded') === 'true';
            if (expanded) {
                content.style.display = 'none';
                header.setAttribute('aria-expanded', 'false');
                var chev = header.querySelector('.chev');
                if (chev) chev.style.transform = '';
            } else {
                content.style.display = 'block';
                header.setAttribute('aria-expanded', 'true');
                var chev = header.querySelector('.chev');
                if (chev) chev.style.transform = 'rotate(90deg)';
            }
        });
    });
});
</script>

<script>
class MINDInterface {
    constructor() {
        this.datasetItems = document.querySelectorAll('.dataset-item');
        this.modeSelectors = document.querySelectorAll('.mode-selectors');
        this.form = document.getElementById('mind-number-form');
        this.numberInput = document.getElementById('numberInput');
        this.topicButtons = document.querySelectorAll('.topic_button') ?? [];
        this.listViewBtn = document.getElementById('list-view-btn');
        this.graphViewBtn = document.getElementById('graph-view-btn');

        this.initEventListeners();
    }

    initEventListeners() {
        // Dataset selection
        this.datasetItems.forEach(item => {
            item.addEventListener('click', () => {
                const datasetName = item.getAttribute("dataset-tm");
                this.handleDatasetSelection(datasetName);
            });
        });

        // Form submission
        if (this.form) {
            this.form.addEventListener('submit', (e) => {
                e.preventDefault();
                const value = parseInt(this.numberInput.value, 10);
                if (!isNaN(value)) {
                    this.handleSubmitNumber(value);
                }
            });
        }

        // Mode selectors
        this.modeSelectors.forEach(selector => {
            selector.addEventListener('click', (e) => {
                e.preventDefault();
                const instruction = 'Analyze contradictions';
                let selected = []
                console.log(window.currentView)

                if (window.currentView === "visual") {
                    selected = window.currentVisibleTopics
                }

                else if (window.currentView === "text") {
                    const checkboxes = document.querySelectorAll('.topic-checkbox');
        
                    selected = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);
                }

                if (selected.length < 1) {
                    alert('Select at least 1 topic.');
                    return;
                }

                const sampleSizeInput = document.getElementById('sampleSizeInput').value

                if (sampleSizeInput < 1) {
                    alert('Sample Size must be greater than 0.');
                    return;
                }
                
                const topics = selected.join(',');
                const TM = document.getElementById('TopicModel-h3').getAttribute("TM-name");
                const config = {
                    "llm": document.getElementById("llmSelect").value,
                    "method": document.getElementById("methodSelect").value
                };
                this.handleInstruction(instruction, topics, TM, sampleSizeInput, config)
            });
        });
    }

    getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrf_token='))
            ?.split('=')[1];
        return cookieValue || '';
    }

    handleDatasetSelection(datasetName) {
        console.log("Selected option:\n", datasetName);

        fetch('/detection_topickeys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken?.() || ''
            },
            body: JSON.stringify(datasetName)
        })
        .then(res => {
            if (!res.ok) throw new Error("Backend error");
            return res.json();
        })
        .then(data => {
            window.location.href = data.redirect;
        })
        .catch(err => console.error("Dataset selection error:", err));
    }

    handleInstruction(instruction, topics, TM, sample_size, config) {
        console.log("Selected instruction:", instruction);
        const data = { "instruction": instruction, "topics": topics, "TM": TM, "sample_size": sample_size, "config": config };
        console.log(data);
        const selector = document.querySelector(`#analyze_contradictions`);
        if (!selector) {
            console.error("Selector not found!");
            return;
        }

        selector.style.pointerEvents = 'none';
        selector.style.opacity = '0.6';
        selector.classList.add('disabled');

        const originalHTML = selector.innerHTML;
        selector.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Waiting...
        `;

        $("#logTerminal").empty();

        console.log(data);
        shouldWarn = true;
        fetch('/mode_selection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken() 
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (res.ok) {
                shouldWarn = false;
                window.location.href = `/detection_results?TM=${encodeURIComponent(TM)}&topics=${encodeURIComponent(topics)}`;
            } else {
                shouldWarn = false;
                console.error("Error al recibir respuesta del backend");
            }
        })
        .catch(err => {
            console.error("Dataset selection error:", err);
            shouldWarn = false;
        })
        .finally(() => {
            selector.style.pointerEvents = 'auto';
            selector.style.opacity = '1';
            selector.classList.remove('disabled');
            selector.innerHTML = originalHTML;
            shouldWarn = false;
        });
    }
}

// Create class MIND
document.addEventListener('DOMContentLoaded', () => {
    console.log("MINDInterface initialized");
    const mindInterface = new MINDInterface();    
});
</script>

{% if csrf_token %}
<script>
    document.cookie = "csrf_token={{ csrf_token }}";
</script>
{% endif %}

<style>
.hover-text-primary:hover {
    color: #007bff;
    cursor: pointer;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = $('#docModal');
    const modalTitle = modal.find('.modal-title');
    const modalBody = modal.find('.modal-body');

    document.querySelectorAll('.view-doc-link').forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();

            const docId = this.getAttribute('data-doc-id');
            const docContent = this.getAttribute('data-doc-content');

            modalTitle.text(`Document ${docId}`);
            modalBody.html(`<pre style="white-space: pre-wrap;">${docContent}</pre>`);

            modal.modal('show');
        });
    });
});
</script>

{% endblock %}
