{% extends "base.html" %}
{% block title %}Detection Results{% endblock %}

{% block content %}
<h1 class="mt-4">Detection Discrepancies Results</h1>
<p>Check below the Detection Results available for use.</p>

{% if datasets %}

{% set combined_data = zip(datasets, names, shape, stages) %}
{% for group in combined_data | groupby(3) %}
    {% if group.grouper == 4 %}
    <hr>

    <div id="accordion-stage-{{ group.grouper }}" class="mt-4">
        {% for dataset, topicmodel_list in dataset_detection.items() %}
            <div class="dataset-group mb-3 border rounded-2 shadow-sm">

                <div class="dataset-header list-group-item hover-text-primary fw-bold bg-light" 
                    role="button"
                    aria-expanded="false"
                    aria-controls="content-{{ loop.index }}"
                    style="cursor:pointer; border:none;">
                    Dataset: {{ dataset }}
                    <span class="chev" aria-hidden="true" style="float:right; transition: transform .2s;">â–¸</span>
                </div>

                <ul id="content-{{ loop.index }}" class="list-group dataset-list" 
                    style="display:none; background-color:#f8f9fa; margin:0; border-top:1px solid #ddd;">
                    {% for tm in topicmodel_list %}
                        {% for item in group.list %}
                            {% set name = item[1] %}
                            {% set shape_tuple = item[2] %}
                            {% if name.replace('_contradiction', '') == tm and shape_tuple %}
                                {% for topics in shape_tuple %}
                                    <li class="list-group-item dataset-item hover-text-primary dataset-entry" 
                                        style="background-color:#f0f0f0; border:none; border-bottom:1px solid #e0e0e0;">
                                        <hr>
                                        <a id="a-{{ name }}-{{ topics }}" href="/detection_results?TM={{ name.replace('_contradiction', '') }}&topics={{ topics }}" style="white-space: pre-wrap;"></a>
                                        <script>document.getElementById('a-{{ name }}-{{ topics }}').innerHTML = '  -> Discrepancy of <strong>"{{ tm }}"</strong> for <strong>{{ topics }} topics.</strong>'</script>
                                    </li>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    </div>
    <br>
    {% endif %}
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.dataset-header').forEach(function(header){
        header.addEventListener('click', function(){
            var contentId = header.getAttribute('aria-controls');
            var content = document.getElementById(contentId);
            if (!content) return;

            var expanded = header.getAttribute('aria-expanded') === 'true';
            if (expanded) {
                content.style.display = 'none';
                header.setAttribute('aria-expanded', 'false');
                var chev = header.querySelector('.chev');
                if (chev) chev.style.transform = '';
            } else {
                content.style.display = 'block';
                header.setAttribute('aria-expanded', 'true');
                var chev = header.querySelector('.chev');
                if (chev) chev.style.transform = 'rotate(90deg)';
            }
        });
    });
});
</script>

{% else %}
<p>No Detection Results available.</p>
{% endif %}
{% endblock %}
