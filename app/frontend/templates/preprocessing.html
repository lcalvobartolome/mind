{% extends "base.html" %}
{% block title %}Preprocessing{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
    <h1 class="mb-5">Preprocess your datasets!</h1>

    <div class="d-flex justify-content-center align-items-center flex-wrap">
        <!-- Step 1 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="1">
            Preprocessing<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 2 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="2">
            Topic Modeling<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 3 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="3">
            Data<br><small>Download</small>
        </div>
    </div>
</div>

<div class="modal fade" id="stepModal" tabindex="-1" role="dialog" aria-labelledby="stepModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content" style="min-width: 550px;">
      <div class="modal-header">
        <h5 class="modal-title" id="stepModalLabel">Step Info</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Step 1: Preprocess Dataset -->
      <div class="modal-body" id="modal-body-1" style="overflow: hidden; position: relative;">

        <!-- Slide 1: Dataset and Output -->
        <div class="step-slide active-slide" id="slide-1">

            <div class="details-toggle" data-target="#detailsSlide1">
                <span>Details</span>
                <i class="arrow"></i>
            </div>

            <div class="collapse mt-2" id="detailsSlide1">
                <div class="card card-body">
                Select which dataset to preprocess and the output name for the preprocess dataset.
                </div>
            </div>

            <hr>

            <label for="optionsDatasets1">Select a dataset:</label>
            <select id="optionsDatasets1">
            {% if datasets %}
                <option value="" disabled selected>-- Choose an available dataset --</option>
                {% for ds, name, stage in zip(datasets, names, stages) %}
                    {% if stage == 1 or stage == '1' %}
                        <option value="{{ name }}">{{ name }}</option>
                    {% endif %}
                {% endfor %}
            {% else %}
                <option value="" disabled>No datasets available.</option>
            {% endif %}
            </select>

            <div class="form-group mt-3">
            <label for="TextColumnOutput-Segmentor">Output Dataset Name:</label>
            <input type="text" id="TextColumnOutput-Segmentor" class="form-control" placeholder="Enter the name for the new dataset">
            </div>
        </div>

        <!-- Slide 2: Segmentor -->
        <div class="step-slide" id="slide-2">
            <h5>Segmentor</h5>

            <hr>

            <div class="details-toggle" data-target="#detailsSlide2">
                <span>Details</span>
                <i class="arrow"></i>
            </div>

            <div class="collapse mt-2" id="detailsSlide2">
                <div class="card card-body details-text" id="detailsSlide2-text">
                    text
                </div>
            </div>

            <hr>

            <div class="form-group mt-3">
            <label for="TextColumn-Segmentor">Text Column:</label>
            <input type="text" id="TextColumn-Segmentor" class="form-control" placeholder="Enter text column name">
            </div>
            <div class="form-group mt-3">
            <label for="MinimumLength-Segmentor">Minimum Length:</label>
            <input type="number" id="MinimumLength-Segmentor" class="form-control" placeholder="100" min="1" value="100">
            </div>
            <div class="form-group mt-3">
            <label for="Separator-Segmentor">Separator:</label>
            <input type="text" id="Separator-Segmentor" class="form-control" placeholder="\\n" value="\n">
            </div>
        </div>

        <!-- Slide 3: Translator -->
        <div class="step-slide" id="slide-3">
            <h5>Translator</h5>

            <hr>

            <div class="details-toggle" data-target="#detailsSlide3">
                <span>Details</span>
                <i class="arrow"></i>
            </div>

            <div class="collapse mt-2" id="detailsSlide3">
                <div class="card card-body details-text" id="detailsSlide3-text">
                text
                </div>
            </div>

            <hr>

            <div class="form-group mt-3">
            <label for="SourceLanguage">Source Language:</label>
            <select id="SourceLanguage" class="form-control">
                <option value="" disabled selected>-- Select source language --</option>
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="de">German (de)</option>
                <option value="it">Italian (it)</option>
            </select>
            </div>
            <div class="form-group mt-3">
            <label for="TargetLanguage">Target Language:</label>
            <select id="TargetLanguage" class="form-control">
                <option value="" disabled selected>-- Select target language --</option>
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="de">German (de)</option>
                <option value="it">Italian (it)</option>
            </select>
            </div>
            <div class="form-group mt-3">
            <label for="LanguageColumnTranslator">Language Column:</label>
            <input type="text" id="LanguageColumnTranslator" class="form-control" placeholder="Enter language column name">
            </div>
        </div>

        <!-- Slide 4: Data Preparer -->
        <div class="step-slide" id="slide-4">
            <h5>Data Preparer</h5>
            
            <div class="details-toggle" data-target="#detailsSlide4">
                <span>Details</span>
                <i class="arrow"></i>
            </div>

            <div class="collapse mt-2" id="detailsSlide4">
                <div class="card card-body">
                The Data Preparer Component allows to build a polylingual dataset.
                </div>
            </div>

            <hr>

            <p>All configuration is ready. Click "Accept Dataset to Preprocess" to continue.</p>
        </div>

        </div>

      <!-- Step 2: Topic Modeling -->
      <div class="modal-body" id="modal-body-2">

        <div class="details-toggle" data-target="#details2-TopicModeling">
            <span>Details</span>
            <i class="arrow"></i>
        </div>

        <div class="collapse mt-2" id="details2-TopicModeling">
            <div class="card card-body details-text" id="details2-TopicModeling-text">
            text
            </div>
        </div>

        <hr>

        <label for="optionsDatasets2">Select an option: </label>
        <select id="optionsDatasets2">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 2 or stage == '2' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No datasets available.</option>
        {% endif %}
        </select>

        <div class="form-group mt-3">
            <label for="outputPath">Output Path:</label>
            <input type="text" id="outputPath2" class="form-control" placeholder="Enter name of the topic modeling">
        </div>

        <hr>

        <div class="form-group mt-3">
            <label for="lang1">Lang 1:</label>
            <select id="lang1" class="form-control">
                <option value="" disabled selected>-- Select lang1 --</option>
                <option value="EN">English (en)</option>
                <option value="ES">Spanish (es)</option>
                <option value="DE">German (de)</option>
                <option value="IT">Italian (it)</option>
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="lang2">Lang 2:</label>
            <select id="lang2" class="form-control">
                <option value="" disabled selected>-- Select lang2 --</option>
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="de">German (de)</option>
                <option value="it">Italian (it)</option>
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="kTopics">K Topics:</label>
            <input type="number" id="kTopics" class="form-control" value="5" min="1">
        </div>
      </div>

      <!-- Step 3: Download -->
      <div class="modal-body" id="modal-body-3">

        <div class="details-toggle" data-target="#details3-Download">
            <span>Details</span>
            <i class="arrow"></i>
        </div>

        <div class="collapse mt-2" id="details3-Download">
            <div class="card card-body" id="details3-Download-text">
                Select an unprocessed or preprocessed dataset to download, or select a topic model.
            </div>
        </div>

        <hr>

        <label for="stage-download">Stage:</label>
        <select id="stage-download" class="form-control">
            <option value="" disabled selected>-- Select Stage --</option>
            <option value="1">Raw Data</option>
            <option value="2">Preprocessed Data</option>
            <option value="3">Topic Model</option>
        </select>

        <br>

        <label id="optionsDatasets3" for="optionsDatasets3" style="display: none;">Select an option: </label>
        
        <select id="optionsDatasets3-1" style="display: none;">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 1 or stage == '1' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No datasets available.</option>
        {% endif %}
        </select>

        <select id="optionsDatasets3-2" style="display: none;">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 2 or stage == '2' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No datasets available.</option>
        {% endif %}
        </select>

        <label id="optionsFormatFile3" for="formatFile3" style="display: none;">Select an extension: </label>
        <select id="formatFile3" style="display: none;">
            <option value="" disabled selected>-- Choose an extension --</option>

            <option value="xlsx">Excel</option> 
            <option value="parquet">Parquet</option> 
        </select>

        <select id="optionsDatasets3-3" style="display: none;">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible model output --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 3 or stage == '3' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No model output available.</option>
        {% endif %}
        </select>

        <hr>

        <div class="form-group mt-3">
            <label for="outputPath">Output Path:</label>
            <input type="text" id="outputPath3" class="form-control" placeholder="Enter new name for the dataset to download">
        </div>
      </div>

      <div class="modal-footer" id="modal-footer-base">
        <!-- Close -->
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

        <!-- Slide Navigation -->
        <button type="button" class="btn btn-outline-primary" id="prevSlide">Previous</button>
        <button type="button" class="btn btn-outline-primary" id="nextSlide">Next</button>

        <!-- Button Preprocess Dataset -->
        <button class="btn btn-primary" id="confirmDatasetPreprocess" style="display: none;">Accept Dataset to Preprocess</button>

        <!-- Button Topic Modelling -->
        <button id="confirmTopicModelling" class="btn btn-primary">Confirm Topic Modeling</button>

        <!-- Button Download -->
        <button id="confirmDownload" class="btn btn-primary">Download Dataset</button>
      </div>

    </div>
  </div>
</div>

<style>
    .step-box {
        width: 150px;
        height: 100px;
        background-color: #f8f9fa;
        border: 2px solid #28a745;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        font-weight: bold;
    }
    .step-box:hover {
        background-color: #e9f7ef;
        transform: scale(1.05);
    }
    .arrow {
        font-size: 2rem;
        margin: 0 15px;
        color: #28a745;
    }

    .details-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        user-select: none;
        border: 1px solid #dee2e6;
    }

    .details-toggle:hover {
        background-color: #e9ecef;
    }

    .details-toggle .arrow {
        border: solid #333;
        border-width: 0 2px 2px 0;
        display: inline-block;
        padding: 4px;
        transform: rotate(45deg);
        transition: transform 0.3s ease;
        margin-left: 10px;
    }

    .details-toggle.active .arrow {
        transform: rotate(-135deg);
    }

    .details-text {
        white-space: pre-wrap;
        tab-size: 4;
        -moz-tab-size: 4;
        line-height: 1.5;
        font-size: inherit;
        font-family: inherit;
    }

    #modal-body-1 {
        overflow: hidden;
        position: relative;
        max-width: 800px;
        width: 100%;
        margin: auto;
        min-height: 250px;
        transition: height 0.5s ease;
        box-sizing: border-box;
        padding: 15px;
    }

    .step-slide {
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        transition: transform 0.5s ease-in-out;
        transform: translateX(100%);
        padding: 15px;
        box-sizing: border-box;
        overflow: visible;
    }

    .step-slide.active-slide {
        transform: translateX(0);
        z-index: 2;
    }

    .step-slide.previous-slide {
        transform: translateX(-100%);
        z-index: 1;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let db_selected = "";
let step1Done = false, step2Done = false, step3Done = false;

let currentSubStep = 1;
const totalSubSteps = 3;

document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('stepModal');
    const modalTitle = modal.querySelector('.modal-title');

    const bodyBase = document.getElementById('modal-body-base');
    const bodyOne = document.getElementById('modal-body-1');
    const bodyTwo = document.getElementById('modal-body-2');

    const footerBase = document.getElementById('modal-footer-base');
    const footerTwo = document.getElementById('modal-footer-2');

    const prevButton = document.getElementById('prevStep2');
    const nextButton = document.getElementById('nextStep2');

    // Step 1
    const datasetPreprocessButton = document.getElementById('confirmDatasetPreprocess');
    
    function Stage1Selection() {
        const selector = document.getElementById("optionsDatasets1");
        const dbSelected = selector.value;

        const textColumnInput = document.getElementById("TextColumn-Segmentor");
        const OutputPathInput = document.getElementById("TextColumnOutput-Segmentor");
        const minLengthInput = document.getElementById("MinimumLength-Segmentor");
        const separatorInput = document.getElementById("Separator-Segmentor");

        const defaultMinLength = 100;
        const defaultSeparator = "\n";

        if (dbSelected !== "" && textColumnInput !== "") {
            db_selected = dbSelected;
            step1Done = true;

            const textColumn = textColumnInput.value.trim();
            const OutputPath = OutputPathInput.value.trim();
            const minLength = minLengthInput.value ? parseInt(minLengthInput.value) : defaultMinLength;
            const separator = separatorInput.value;
            
            const segmentor_data = {
                "output": OutputPath,
                "text_col": textColumn,
                "min_length": minLength,
                "sep": separator
            }

            const translator_data = {
                "output": OutputPath,
                "text_col": textColumn,
                "lang_col": document.getElementById('LanguageColumnTranslator').value.trim(),
                "src_lang": document.getElementById('SourceLanguage').value,
                "tgt_lang": document.getElementById('TargetLanguage').value
            }

            const preparer_data = {
                "output": OutputPath,
                "src_lang": document.getElementById('SourceLanguage').value,
                "tgt_lang": document.getElementById('TargetLanguage').value,
                "schema": {
                    "chunk_id": "id_preproc",
                    "doc_id": "id",
                    "text": "text",
                    "full_doc": "summary",
                    "lang": "lang",
                    "title": "title",
                    "url": "url",
                    "equivalence": "equivalence"
                }
            }

            const data = {
                'dataset': db_selected,
                'segmentor_data': segmentor_data,
                'translator_data': translator_data,
                'preparer_data': preparer_data
            }

            console.log(data);

            fetch("/preprocess/Stage1", {
                method: "POST", 
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data), 
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP Error: ${response.status}`);
                    });
                }

                return response.json();
            })
            .then(response => {
                console.log('Success (' + response.status + '): ' + response.message);
                updateProgressBar();

                const select2 = document.getElementById('optionsDatasets2');
                const select3 = document.getElementById('optionsDatasets3-2');
                const newOption = document.createElement('option');

                newOption.value = OutputPath;
                newOption.text = OutputPath;
                
                select2.appendChild(newOption);
                select3.appendChild(newOption);
            })
            .catch(error => {
                console.error("Error in Fetch/AJAX:", error.message);
            });

        } else {
            step1Done = false;
            alert('Please select an available dataset before accepting.');
        }
    }

    if (datasetPreprocessButton) {
        datasetPreprocessButton.addEventListener('click', Stage1Selection);
    }

    // Click on boxes
    const stepBoxes = document.querySelectorAll('.step-box');

    function showCorrectModalBody(event) {
        const stepNumber = event.currentTarget.dataset.step;

        const targetId = 'modal-body-' + stepNumber;

        const allModalBodies = document.querySelectorAll('[id^="modal-body-"]');
        allModalBodies.forEach(body => {
            body.style.display = 'none';
        });

        const targetBody = document.getElementById(targetId);
        if (targetBody) {
            targetBody.style.display = 'block';
        }

        // Buttons Next & Prev Slides only on 1
        if (document.getElementById('modal-body-1').style.display != "none") {
            if (stepNumber == 1) {
                document.getElementById('nextSlide').style.display = 'block';
                document.getElementById('prevSlide').style.display = 'none';
            }
            else if (stepNumber == 2) {
                document.getElementById('nextSlide').style.display = 'block';
                document.getElementById('prevSlide').style.display = 'block';
            }
            else if (stepNumber == 3) {
                document.getElementById('nextSlide').style.display = 'none';
                document.getElementById('prevSlide').style.display = 'block';
            }
            else {
                document.getElementById('nextSlide').style.display = 'none';
                document.getElementById('prevSlide').style.display = 'none';
            }
        }
        else {
            document.getElementById('nextSlide').style.display = 'none';
            document.getElementById('prevSlide').style.display = 'none';
        }

        const stepModalLabel = document.getElementById('stepModalLabel');
        if (stepNumber == 1) {
            stepModalLabel.textContent = 'Step 1: Preprocess info';

            // document.getElementById('nextSlide').style.display = 'block';
            // document.getElementById('prevSlide').style.display = 'none';

            document.getElementById('confirmDatasetPreprocess').style.display = 'none';
            document.getElementById('confirmTopicModelling').style.display = 'none';
            document.getElementById('confirmDownload').style.display = 'none';
        }
        else if (stepNumber == 2) {
            stepModalLabel.textContent = 'Step 2: Topic Modeling info';

            // document.getElementById('nextSlide').style.display = 'block';
            // document.getElementById('prevSlide').style.display = 'block';

            document.getElementById('confirmDatasetPreprocess').style.display = 'none';
            document.getElementById('confirmTopicModelling').style.display = 'block';
            document.getElementById('confirmDownload').style.display = 'none';
        }
        else if (stepNumber == 3) {
            stepModalLabel.textContent = 'Step 3: Download info';

            // document.getElementById('nextSlide').style.display = 'none';
            // document.getElementById('prevSlide').style.display = 'block';

            document.getElementById('confirmDatasetPreprocess').style.display = 'none';
            document.getElementById('confirmTopicModelling').style.display = 'none';
            document.getElementById('confirmDownload').style.display = 'block';
        }
    }

    stepBoxes.forEach(box => {
        box.addEventListener('click', showCorrectModalBody);
    });
});
</script>

<script>
document.getElementById("confirmTopicModelling").addEventListener("click", function() {
    const dataset = document.getElementById("optionsDatasets2").value;
    const outputPath = document.getElementById("outputPath2").value.trim();
    const lang1 = document.getElementById("lang1").value;
    const lang2 = document.getElementById("lang2").value;
    const kTopics = document.getElementById("kTopics").value;

    if (!dataset || !outputPath || !lang1 || !lang2 || !kTopics) {
        alert("Please fill in all fields before continuing.");
        return;
    }

    if (lang1 === lang2) {
        alert("Lang1 and Lang2 cannot be the same.");
        return;
    }

    const data = {
        "dataset": dataset,
        "output": outputPath,
        "lang1": lang1,
        "lang2": lang2,
        "k": kTopics
    }

    console.log(data);

    fetch("/preprocess/Stage2", {
        method: "POST", 
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data), 
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || `HTTP Error: ${response.status}`);
            });
        }

        return response.json();
    })
    .then(response => {
        console.log('Success (' + response.status + '): ' + response.message);
        updateProgressBar();
    })
    .catch(error => {
        console.error("Error in Fetch/AJAX:", error.message);
    });
});
</script>

<script>
document.getElementById("confirmDownload").addEventListener("click", function() {
    const stage = document.getElementById("stage-download").value;

    if (!stage) {
        alert("Please fill in all fields before continuing.");
        return;
    }
    
    const dataset = document.getElementById("optionsDatasets3-" + stage).value;
    const outputPath = document.getElementById("outputPath3").value.trim();
    const formatFile = document.getElementById("formatFile3").value;

    if (!dataset || !outputPath || !formatFile) {
        alert("Please fill in all fields before continuing.");
        return;
    }

    let output = "";
    if (stage === "1" || stage === "2") {
        output = outputPath + "." + formatFile;
    }
    else if (stage === "3") {
        output = outputPath + ".zip";
    }

    const data = {
        "stage": stage,
        "dataset": dataset,
        "output": output,
        "format": formatFile
    }

    console.log(data);

    fetch("/preprocess/download", {
        method: "POST", 
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data), 
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || `HTTP Error: ${response.status}`); });
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = data.output;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        console.log("Descarga iniciada.");
        updateProgressBar();
    })
    .catch(error => {
        console.error("Error in Fetch/AJAX:", error.message);
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stageSelect = document.getElementById('stage-download');
    const labelDataset = document.getElementById('optionsDatasets3');
    const labelFormat = document.getElementById('optionsFormatFile3');
    const formatFile = document.getElementById('formatFile3');
    const options1 = document.getElementById('optionsDatasets3-1');
    const options2 = document.getElementById('optionsDatasets3-2');
    const options3 = document.getElementById('optionsDatasets3-3');

    stageSelect.addEventListener('change', function() {
        const selectedValue = this.value;

        if (selectedValue === '1') {
            labelDataset.style.display = '';
            labelFormat.style.display = '';
            formatFile.style.display = '';
            options1.style.display = '';
            options2.style.display = 'none';
            options3.style.display = 'none';
        } else if (selectedValue === '2') {
            labelDataset.style.display = '';
            labelFormat.style.display = '';
            formatFile.style.display = '';
            options1.style.display = 'none';
            options2.style.display = '';
            options3.style.display = 'none';
        } else if (selectedValue === '3') {
            labelDataset.style.display = '';
            labelFormat.style.display = 'none';
            formatFile.style.display = 'none';
            options1.style.display = 'none';
            options2.style.display = 'none';
            options3.style.display = '';
        } else {
            labelDataset.style.display = 'none';
            labelFormat.style.display = 'none';
            formatFile.style.display = 'none';
            options1.style.display = 'none';
            options2.style.display = 'none';
            options3.style.display = 'none';
        }
    });
});
</script>

<script>
let currentSlide = 0;

document.addEventListener('DOMContentLoaded', function() {
  const slides = document.querySelectorAll('#modal-body-1 .step-slide');
  const modalBody1 = document.getElementById('modal-body-1');
  const totalSlides = slides.length;

  const nextBtn = document.getElementById('nextSlide');
  const prevBtn = document.getElementById('prevSlide');
  const preprocessBtn = document.getElementById('confirmDatasetPreprocess');

  function adjustHeight(index) {
    const slide = slides[index];
    if (slide) {
      const slideHeight = slide.scrollHeight;
      modalBody1.style.height = slideHeight + 'px';
    }
  }

  function showSlide(index) {
    slides.forEach((slide, i) => {
        slide.classList.remove('active-slide', 'previous-slide');
        if (i < index) slide.classList.add('previous-slide');
        else if (i === index) slide.classList.add('active-slide');
    });
    
    // Detenemos observadores anteriores
    activeResizeObserver.disconnect();

    // Observa el slide activo en tiempo real
    const activeSlide = slides[index];
    activeResizeObserver.observe(activeSlide);

    currentSlide = index;
    updateNav();
    adjustHeight(currentSlide);
    }

  function updateNav() {
    prevBtn.style.display = currentSlide > 0 ? '' : 'none';
    nextBtn.style.display = currentSlide < totalSlides - 1 ? '' : 'none';
    preprocessBtn.style.display = currentSlide === totalSlides - 1 ? '' : 'none';
  }

  function validateInputsTranslator() {
        const textCol = document.getElementById('TextColumn-Segmentor').value.trim();
        const langCol = document.getElementById('LanguageColumnTranslator').value.trim();
        const sourceLang = document.getElementById('SourceLanguage').value;
        const targetLang = document.getElementById('TargetLanguage').value;

        // Valid combinations
        const validCombinations = [
            ["en", "es"],
            ["es", "en"],
            ["en", "de"],
            ["de", "en"],
            ["en", "it"],
            ["it", "en"]
        ];

        if (!textCol || !langCol) {
            alert("Text Column and Language Column cannot be empty.");
            return false;
        }

        const isValidCombo = validCombinations.some(
            combo => combo[0] === sourceLang && combo[1] === targetLang
        );

        if (!isValidCombo) {
            alert("Invalid Source and Target language combination.");
            return false;
        }
        return true;
    }

  function verifyParamsSlide(idx) {
    if (idx == 0) {
        const selector = document.getElementById("optionsDatasets1");
        const dbSelected = selector.value;
        const OutputPathInput = document.getElementById("TextColumnOutput-Segmentor").value.trim();

        if (dbSelected == "" || OutputPathInput == "") {
            alert("Select dataset to preprocess and an output name.");
            return false;
        }
        return true;
    }
    else if (idx == 1) {
        const textColumnInput = document.getElementById("TextColumn-Segmentor").value;
        const minLengthInput = document.getElementById("MinimumLength-Segmentor").value;
        const separatorInput = document.getElementById("Separator-Segmentor").value;

        if (textColumnInput.value == "") {
            alert("Indicate the text label to preprocess.");
            return false;
        }

        const defaultMinLength = 100;
        const defaultSeparator = "\n";

        if (!(/^-?\d+$/.test(minLengthInput))) {
            alert("Minimum Length must be an integer.");
            return false;
        }
        else if (minLengthInput <= 0) alert("Minimum Length should be equal or greater than 1, so it will be used 100 as Minimum Length.");

        if (separatorInput == "") alert("The separator input is empty, so it will be used \\n as separator.");

        return true;
    }
    else if (idx == 2) {
        return validateInputsTranslator();
    }
    return false;
  }

    nextBtn.addEventListener('click', () => {
        let verified = false;

        verified = verifyParamsSlide(currentSlide);

        if (verified)
            if (currentSlide < totalSlides - 1)
                showSlide(currentSlide + 1);
    });

    prevBtn.addEventListener('click', () => {
        if (currentSlide > 0) showSlide(currentSlide - 1);
    });


    $('#stepModal').on('hidden.bs.modal', function () {
        showSlide(0);
    });

    const activeResizeObserver = new ResizeObserver(() => {
        adjustHeight(currentSlide);
    });

    showSlide(0);
    window.addEventListener('resize', () => adjustHeight(currentSlide));

    // Text for Details
    document.getElementById('detailsSlide2-text').textContent = 'The Segmenter Component allows to split documents into segments. Options:\n\n' +
        ' - Text Column\t\t\tName of the text column to segment.\n' +
        ' - Minimum Length\tMinimum length for a paragraph to be kept.\n' +
        ' - Separator\t\t\t\tSeparator for splitting paragraphs.';

    document.getElementById('detailsSlide3-text').textContent = 'The Translate Component allows to translate a DataFrame using the Translator class. Options:\n\n' +
        ' - Source Language\t\tSource language code.\n' +
        ' - Target Language\t\tTarget language code.\n' +
        ' - Language Column\t\tName of the language column.';

    document.getElementById('details2-TopicModeling-text').textContent = 'The Topic Modeling Component allows to train a Mallet Polylingual Topic Model using PolylingualTM wrapper. Options:\n\n' +
        ' - Lang 1\t\t\tFirst language code.\n' +
        ' - Lang 2\t\t\tSecond language code.\n' +
        ' - K Topics\t\tNumber of topics to extract.';

    const toggles = document.querySelectorAll('.details-toggle');

    toggles.forEach(toggle => {
        const targetId = toggle.getAttribute('data-target');
        const collapseEl = document.querySelector(targetId);
        if (!collapseEl) return;

        $(collapseEl).off('shown.bs.collapse hidden.bs.collapse');

        $(collapseEl).on('shown.bs.collapse', () => {toggle.classList.add('active');});

        $(collapseEl).on('hidden.bs.collapse', () => {toggle.classList.remove('active');});

        toggle.addEventListener('click', () => {
            if (window.jQuery) {
                const isShown = $(collapseEl).hasClass('show');

                if (isShown) $(collapseEl).collapse('hide');
                else $(collapseEl).collapse('show');

                toggle.classList.toggle('active', !isShown);

                const start = performance.now();
                const duration = 350;
                const monitor = setInterval(() => {
                    showSlide(currentSlide);
                    if (performance.now() - start > duration) clearInterval(monitor);
                }, 16);

                return;
            }
        });
    });
});
</script>

{% endblock %}
