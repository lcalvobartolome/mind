{% extends "base.html" %}
{% block title %}Preprocessing{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
    <h1 class="mb-5">Preprocess your datasets!</h1>

    <div class="d-flex justify-content-center align-items-center flex-wrap">
        <!-- Step 1 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="1">
            Preprocessing<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 2 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="2">
            Topic Modeling<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 3 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="3">
            Data<br><small>Download</small>
        </div>
    </div>
</div>

<div class="modal fade" id="stepModal" tabindex="-1" role="dialog" aria-labelledby="stepModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stepModalLabel">Step Info</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Step 1: Preprocess Dataset -->
      <div class="modal-body" id="modal-body-1">
        <label for="optionsDatasets1">Select an option: </label>
        <select id="optionsDatasets1">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 1 or stage == '1' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No datasets available.</option>
        {% endif %}
        </select>

        <div class="form-group mt-3">
            <label for="TextColumnOutput-Segmentor">Output Dataset Name:</label>
            <input type="text" id="TextColumnOutput-Segmentor" class="form-control" placeholder="Enter the name for the new dataset">
        </div>

        <hr>

        <!-- Section: Segmentor -->
        <h5>Segmentor</h5>
        <div class="form-group mt-3">
            <label for="TextColumn-Segmentor">Text Column:</label>
            <input type="text" id="TextColumn-Segmentor" class="form-control" placeholder="Enter text column name">
        </div>

        <div class="form-group mt-3">
            <label for="MinimumLength-Segmentor">Minimum Length:</label>
            <input type="number" id="MinimumLength-Segmentor" class="form-control" placeholder="100" min="1" value="100">
        </div>

        <div class="form-group mt-3">
            <label for="Separator-Segmentor">Separator:</label>
            <input type="text" id="Separator-Segmentor" class="form-control" placeholder="\\n" value="\n">
        </div>

        <hr>

        <!-- Translator Section -->
        <h5>Translator</h5>
        <div class="form-group mt-3">
            <label for="SourceLanguage">Source Language:</label>
            <select id="SourceLanguage" class="form-control">
                <option value="" disabled selected>-- Select source language --</option>
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="de">German (de)</option>
                <option value="it">Italian (it)</option>
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="TargetLanguage">Target Language:</label>
            <select id="TargetLanguage" class="form-control">
                <option value="" disabled selected>-- Select target language --</option>
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="de">German (de)</option>
                <option value="it">Italian (it)</option>
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="LanguageColumnTranslator">Language Column:</label>
            <input type="text" id="LanguageColumnTranslator" class="form-control" placeholder="Enter language column name">
        </div>
      </div>

      <!-- Step 2: Topic Modeling -->
      <div class="modal-body" id="modal-body-2">
        <label for="optionsDatasets2">Select an option: </label>
        <select id="optionsDatasets2">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 2 or stage == '2' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No datasets available.</option>
        {% endif %}
        </select>

        <div class="form-group mt-3">
            <label for="outputPath">Output Path:</label>
            <input type="text" id="outputPath2" class="form-control" placeholder="Enter name of the topic modeling">
        </div>

        <hr>

        <div class="form-group mt-3">
            <label for="lang1">Lang 1:</label>
            <select id="lang1" class="form-control">
                <option value="" disabled selected>-- Select lang1 --</option>
                <option value="EN">English (en)</option>
                <option value="ES">Spanish (es)</option>
                <option value="DE">German (de)</option>
                <option value="IT">Italian (it)</option>
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="lang2">Lang 2:</label>
            <select id="lang2" class="form-control">
                <option value="" disabled selected>-- Select lang2 --</option>
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="de">German (de)</option>
                <option value="it">Italian (it)</option>
            </select>
        </div>

        <div class="form-group mt-3">
            <label for="kTopics">K Topics:</label>
            <input type="number" id="kTopics" class="form-control" value="5" min="1">
        </div>
      </div>

      <!-- Step 3: Download -->
      <div class="modal-body" id="modal-body-3">

        <label for="stage-download">Stage:</label>
        <select id="stage-download" class="form-control">
            <option value="" disabled selected>-- Select Stage --</option>
            <option value="1">Raw Data</option>
            <option value="2">Preprocessed Data</option>
            <option value="3">Topic Model</option>
        </select>

        <br>

        <label id="optionsDatasets3" for="optionsDatasets3" style="display: none;">Select an option: </label>
        
        <select id="optionsDatasets3-1" style="display: none;">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 1 or stage == '1' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No datasets available.</option>
        {% endif %}
        </select>

        <select id="optionsDatasets3-2" style="display: none;">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 2 or stage == '2' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No datasets available.</option>
        {% endif %}
        </select>

        <select id="optionsDatasets3-3" style="display: none;">
        {% if datasets %}
            <option value="" disabled selected>-- Choose an avaible model output --</option>
            {% for ds, name, stage in zip(datasets, names, stages) %}
                {% if stage == 3 or stage == '3' %}
                    <option value="{{ name }}">{{ name }}</option> 
                {% endif %}
            {% endfor %}
        {% else %}
            <option value="" disabled>No model output available.</option>
        {% endif %}
        </select>

        <hr>

        <div class="form-group mt-3">
            <label for="outputPath">Output Path:</label>
            <input type="text" id="outputPath3" class="form-control" placeholder="Enter new name for the dataset to download">
        </div>
      </div>

      <div class="modal-footer" id="modal-footer-base">
        <!-- Close -->
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

        <!-- Button Preprocess Dataset -->
        <button class="btn btn-primary" id="confirmDatasetPreprocess">Accept Dataset to Preprocess</button>

        <!-- Button Topic Modelling -->
        <button id="confirmTopicModelling" class="btn btn-primary">Confirm Topic Modeling</button>

        <!-- Button Download -->
        <button id="confirmDownload" class="btn btn-primary">Download Dataset</button>
      </div>

    </div>
  </div>
</div>

<style>
    .step-box {
        width: 150px;
        height: 100px;
        background-color: #f8f9fa;
        border: 2px solid #28a745;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        font-weight: bold;
    }
    .step-box:hover {
        background-color: #e9f7ef;
        transform: scale(1.05);
    }
    .arrow {
        font-size: 2rem;
        margin: 0 15px;
        color: #28a745;
    }

    .step-container {
        overflow: hidden;
        position: relative;
        height: 150px;
    }

    .step-slide {
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        transition: transform 0.5s ease-in-out;
        transform: translateX(100%);
        padding: 15px;
    }

    .step-slide.active-slide {
        transform: translateX(0);
    }

    .step-slide.previous-slide {
        transform: translateX(-100%);
    }
</style>

<script>
let db_selected = "";
let step1Done = false, step2Done = false, step3Done = false;

let currentSubStep = 1;
const totalSubSteps = 3;

document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('stepModal');
    const modalTitle = modal.querySelector('.modal-title');

    const bodyBase = document.getElementById('modal-body-base');
    const bodyOne = document.getElementById('modal-body-1');
    const bodyTwo = document.getElementById('modal-body-2');

    const footerBase = document.getElementById('modal-footer-base');
    const footerTwo = document.getElementById('modal-footer-2');

    const prevButton = document.getElementById('prevStep2');
    const nextButton = document.getElementById('nextStep2');

    // Step 1
    const datasetPreprocessButton = document.getElementById('confirmDatasetPreprocess');

    function validateInputsTranslator() {
        const textCol = document.getElementById('TextColumn-Segmentor').value.trim();
        const langCol = document.getElementById('LanguageColumnTranslator').value.trim();
        const sourceLang = document.getElementById('SourceLanguage').value;
        const targetLang = document.getElementById('TargetLanguage').value;

        // Valid combinations
        const validCombinations = [
            ["en", "es"],
            ["es", "en"],
            ["en", "de"],
            ["de", "en"],
            ["en", "it"],
            ["it", "en"]
        ];

        if (!textCol || !langCol) {
            alert("Text Column and Language Column cannot be empty.");
            return false;
        }

        const isValidCombo = validCombinations.some(
            combo => combo[0] === sourceLang && combo[1] === targetLang
        );

        if (!isValidCombo) {
            alert("Invalid Source and Target language combination.");
            return false;
        }
        return true;
    }
    
    function Stage1Selection() {
        const selector = document.getElementById("optionsDatasets1");
        const dbSelected = selector.value;

        const textColumnInput = document.getElementById("TextColumn-Segmentor");
        const OutputPathInput = document.getElementById("TextColumnOutput-Segmentor");
        const minLengthInput = document.getElementById("MinimumLength-Segmentor");
        const separatorInput = document.getElementById("Separator-Segmentor");

        const defaultMinLength = 100;
        const defaultSeparator = "\n";

        if (dbSelected !== "" && textColumnInput !== "") {
            db_selected = dbSelected;
            step1Done = true;

            if (!validateInputsTranslator()) return;

            const textColumn = textColumnInput.value.trim();
            const OutputPath = OutputPathInput.value.trim();
            const minLength = minLengthInput.value ? parseInt(minLengthInput.value) : defaultMinLength;
            const separator = separatorInput.value;
            
            const segmentor_data = {
                "output": OutputPath,
                "text_col": textColumn,
                "min_length": minLength,
                "sep": separator
            }

            const translator_data = {
                "output": OutputPath,
                "text_col": textColumn,
                "lang_col": document.getElementById('LanguageColumnTranslator').value.trim(),
                "src_lang": document.getElementById('SourceLanguage').value,
                "tgt_lang": document.getElementById('TargetLanguage').value
            }

            const preparer_data = {
                "output": OutputPath,
                "src_lang": document.getElementById('SourceLanguage').value,
                "tgt_lang": document.getElementById('TargetLanguage').value,
                "schema": {
                    "chunk_id": "id_preproc",
                    "doc_id": "id",
                    "text": "text",
                    "full_doc": "summary",
                    "lang": "lang",
                    "title": "title",
                    "url": "url",
                    "equivalence": "equivalence"
                }
            }

            const data = {
                'dataset': db_selected,
                'segmentor_data': segmentor_data,
                'translator_data': translator_data,
                'preparer_data': preparer_data
            }

            console.log(data);

            fetch("/preprocess/Stage1", {
                method: "POST", 
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data), 
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP Error: ${response.status}`);
                    });
                }

                return response.json();
            })
            .then(response => {
                console.log('Success (' + response.status + '): ' + response.message);
                updateProgressBar();

                const select2 = document.getElementById('optionsDatasets2');
                const select3 = document.getElementById('optionsDatasets3-2');
                const newOption = document.createElement('option');

                newOption.value = OutputPath;
                newOption.text = OutputPath;
                
                select2.appendChild(newOption);
                select3.appendChild(newOption);
            })
            .catch(error => {
                console.error("Error in Fetch/AJAX:", error.message);
            });

        } else {
            step1Done = false;
            alert('Please select an available dataset before accepting.');
        }
    }

    if (datasetPreprocessButton) {
        datasetPreprocessButton.addEventListener('click', Stage1Selection);
    }

    // Click on boxes
    const stepBoxes = document.querySelectorAll('.step-box');

    function showCorrectModalBody(event) {
        const stepNumber = event.currentTarget.dataset.step;
        const targetId = 'modal-body-' + stepNumber;

        const allModalBodies = document.querySelectorAll('[id^="modal-body-"]');
        allModalBodies.forEach(body => {
            body.style.display = 'none';
        });

        const targetBody = document.getElementById(targetId);
        if (targetBody) {
            targetBody.style.display = 'block';
        }

        const stepModalLabel = document.getElementById('stepModalLabel');
        if (stepNumber == 1) {
            stepModalLabel.textContent = 'Step 1: Preprocess info';
            document.getElementById('confirmDatasetPreprocess').style.display = 'block';
            document.getElementById('confirmTopicModelling').style.display = 'none';
            document.getElementById('confirmDownload').style.display = 'none';
        }
        else if (stepNumber == 2) {
            stepModalLabel.textContent = 'Step 2: Topic Modeling info';
            document.getElementById('confirmDatasetPreprocess').style.display = 'none';
            document.getElementById('confirmTopicModelling').style.display = 'block';
            document.getElementById('confirmDownload').style.display = 'none';
        }
        else if (stepNumber == 3) {
            stepModalLabel.textContent = 'Step 3: Download info';
            document.getElementById('confirmDatasetPreprocess').style.display = 'none';
            document.getElementById('confirmTopicModelling').style.display = 'none';
            document.getElementById('confirmDownload').style.display = 'block';
        }
    }

    stepBoxes.forEach(box => {
        box.addEventListener('click', showCorrectModalBody);
    });
});
</script>

<script>
document.getElementById("confirmTopicModelling").addEventListener("click", function() {
    const dataset = document.getElementById("optionsDatasets2").value;
    const outputPath = document.getElementById("outputPath2").value.trim();
    const lang1 = document.getElementById("lang1").value;
    const lang2 = document.getElementById("lang2").value;
    const kTopics = document.getElementById("kTopics").value;

    if (!dataset || !outputPath || !lang1 || !lang2 || !kTopics) {
        alert("Please fill in all fields before continuing.");
        return;
    }

    if (lang1 === lang2) {
        alert("Lang1 and Lang2 cannot be the same.");
        return;
    }

    const data = {
        "dataset": dataset,
        "output": outputPath,
        "lang1": lang1,
        "lang2": lang2,
        "k": kTopics
    }

    console.log(data);

    fetch("/preprocess/Stage2", {
        method: "POST", 
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data), 
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || `HTTP Error: ${response.status}`);
            });
        }

        return response.json();
    })
    .then(response => {
        console.log('Success (' + response.status + '): ' + response.message);
        updateProgressBar();
    })
    .catch(error => {
        console.error("Error in Fetch/AJAX:", error.message);
    });
});
</script>

<script>
document.getElementById("confirmDownload").addEventListener("click", function() {
    const stage = document.getElementById("stage-download").value;

    if (!stage) {
        alert("Please fill in all fields before continuing.");
        return;
    }
    
    const dataset = document.getElementById("optionsDatasets3-" + stage).value;
    const outputPath = document.getElementById("outputPath3").value.trim();

    if (!dataset || !outputPath) {
        alert("Please fill in all fields before continuing.");
        return;
    }

    let output = "";
    if (stage === "1" || stage === "2") {
        output = outputPath + ".parquet";
    }
    else if (stage === "3") {
        output = outputPath + ".zip";
    }

    const data = {
        "stage": stage,
        "dataset": dataset,
        "output": output
    }

    console.log(data);

    fetch("/preprocess/download", {
        method: "POST", 
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data), 
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || `HTTP Error: ${response.status}`); });
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = data.output;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        console.log("Descarga iniciada.");
        updateProgressBar();
    })
    .catch(error => {
        console.error("Error in Fetch/AJAX:", error.message);
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stageSelect = document.getElementById('stage-download');
    const labelDataset = document.getElementById('optionsDatasets3');
    const options1 = document.getElementById('optionsDatasets3-1');
    const options2 = document.getElementById('optionsDatasets3-2');
    const options3 = document.getElementById('optionsDatasets3-3');

    stageSelect.addEventListener('change', function() {
        const selectedValue = this.value;

        if (selectedValue === '1') {
            labelDataset.style.display = '';
            options1.style.display = '';
            options2.style.display = 'none';
            options3.style.display = 'none';
        } else if (selectedValue === '2') {
            labelDataset.style.display = '';
            options1.style.display = 'none';
            options2.style.display = '';
            options3.style.display = 'none';
        } else if (selectedValue === '3') {
            labelDataset.style.display = '';
            options1.style.display = 'none';
            options2.style.display = 'none';
            options3.style.display = '';
        } else {
            labelDataset.style.display = 'none';
            options1.style.display = 'none';
            options2.style.display = 'none';
            options3.style.display = 'none';
        }
    });
});
</script>

{% endblock %}
