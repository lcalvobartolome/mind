{% extends "base.html" %}
{% block title %}Preprocessing{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
    <h1 class="mb-5">Preprocess your datasets!</h1>

    <div class="d-flex justify-content-center align-items-center flex-wrap">
        <!-- Step 1 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="1">
            Preprocessing<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 2 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="2">
            Topic Modeling<br><small>Click to tune</small>
        </div>

        <div class="arrow">&#8594;</div>

        <!-- Step 3 -->
        <div class="step-box" data-toggle="modal" data-target="#stepModal" data-step="3">
            Data<br><small>Download</small>
        </div>
    </div>
</div>

<div class="modal fade" id="stepModal" tabindex="-1" role="dialog" aria-labelledby="stepModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="stepModalLabel">Step Info</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Step 1: Preprocess Dataset -->
      <div class="modal-body" id="modal-body-1">
        <label for="optionsDatasets">Select an option: </label>
        <select id="optionsDatasets">
          {% if datasets %}
          <option value="" disabled selected>-- Choose an avaible dataset --</option>
            {% for ds in datasets %}
            <option value="{{ names[loop.index - 1] }}">{{ names[loop.index - 1] }}</option> 
            {% endfor %}
          {% else %}
          <p>No datasets available.</p>
          {% endif %}
        </select>

        <div class="form-group mt-3">
            <label for="TextColumnOutput-Segmentor">Output Dataset Name:</label>
            <input type="text" id="TextColumnOutput-Segmentor" class="form-control" placeholder="Enter the name for the new dataset">
        </div>

        <hr>

        <div class="form-group mt-3">
            <label for="TextColumn-Segmentor">Text Column:</label>
            <input type="text" id="TextColumn-Segmentor" class="form-control" placeholder="Enter text column name">
        </div>

        <div class="form-group mt-3">
            <label for="MinimumLength-Segmentor">Minimum Length:</label>
            <input type="number" id="MinimumLength-Segmentor" class="form-control" placeholder="100" min="1" value="100">
        </div>

        <div class="form-group mt-3">
            <label for="Separator-Segmentor">Separator:</label>
            <input type="text" id="Separator-Segmentor" class="form-control" placeholder="\\n" value="\n">
        </div>
        
        <button type="button" class="btn btn-secondary mt-3" id="confirmDatasetPreprocess">Accept Dataset to Preprocess</button>

      <!-- Step 2: Preprocessing -->
      <div class="modal-body" id="modal-body-2">
        <div id="step2Container" class="step-container"> 
          <div id="modal-body-2-1" class="step-slide">
            <p>Ready to preprocess dataset:
              <b id="dbSelectedStep2"></b>.
            </p>
            <p>Click Confirm to run the backend process.</p>
          </div>

          <div id="modal-body-step2-2" class="step-slide">
              <p>Define the **data types** for key columns.</p>
              <ul id="columnTypesList" class="mb-3">
                  <li>Feature A: <input type="text" placeholder="Type (e.g., Categorical)"></li>
              </ul> 
          </div>

          <div id="modal-body-step2-3" class="step-slide">
              <p>Review the configuration and click **Accept Action** to run the preprocessor on: <b id="dbSelectedFinal"></b>.</p>
              <p>Ready for final execution.</p>
          </div>
        </div>
      </div>

      <div class="modal-footer" id="modal-footer-2">
        <button type="button" class="btn btn-secondary" id="prevStep2">< Prev</button>
        <button type="button" class="btn btn-primary" id="nextStep2" data-dismiss="">Next ></button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>

      <!-- Ejemplo Base -->
      <div class="modal-body" id="modal-body-base">
        This is placeholder content. It will change depending on the step clicked.
      </div>

      <div class="modal-footer" id="modal-footer-base">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<style>
    .step-box {
        width: 150px;
        height: 100px;
        background-color: #f8f9fa;
        border: 2px solid #28a745;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        font-weight: bold;
    }
    .step-box:hover {
        background-color: #e9f7ef;
        transform: scale(1.05);
    }
    .arrow {
        font-size: 2rem;
        margin: 0 15px;
        color: #28a745;
    }

    .step-container {
        overflow: hidden;
        position: relative;
        height: 150px;
    }

    .step-slide {
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        transition: transform 0.5s ease-in-out;
        transform: translateX(100%);
        padding: 15px;
    }

    .step-slide.active-slide {
        transform: translateX(0);
    }

    .step-slide.previous-slide {
        transform: translateX(-100%);
    }
</style>

<script>
let db_selected = "";
let step1Done = false, step2Done = false, step3Done = false;

let currentSubStep = 1;
const totalSubSteps = 3;

document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('stepModal');
    const modalTitle = modal.querySelector('.modal-title');

    const bodyBase = document.getElementById('modal-body-base');
    const bodyOne = document.getElementById('modal-body-1');
    const bodyTwo = document.getElementById('modal-body-2');

    const footerBase = document.getElementById('modal-footer-base');
    const footerTwo = document.getElementById('modal-footer-2');

    const prevButton = document.getElementById('prevStep2');
    const nextButton = document.getElementById('nextStep2');

    // Step 1
    const selector = document.getElementById('optionsDatasets');
    const datasetButton = document.getElementById('confirmDatasetPreprocess');
    
    function Stage1Selection() {
        const selector = document.getElementById("optionsDatasets");
        const dbSelected = selector.value;

        const textColumnInput = document.getElementById("TextColumn-Segmentor");
        const OutputPathInput = document.getElementById("TextColumnOutput-Segmentor");
        const minLengthInput = document.getElementById("MinimumLength-Segmentor");
        const separatorInput = document.getElementById("Separator-Segmentor");

        const defaultMinLength = 100;
        const defaultSeparator = "\n";

        if (dbSelected !== "" && textColumnInput !== "") {
            db_selected = dbSelected;
            step1Done = true;

            const textColumn = textColumnInput.value.trim();
            const OutputPath = OutputPathInput.value.trim();
            const minLength = minLengthInput.value ? parseInt(minLengthInput.value) : defaultMinLength;
            const separator = separatorInput.value.trim() !== "" ? separatorInput.value : defaultSeparator;
            
            const segmentor_data = {
                "output": OutputPath,
                "text_col": textColumn,
                "min_length": minLength,
                "sep": separator
            }

            const translator_data = {
                "output": OutputPath
            }

            const preparer_data = {
                "output": OutputPath
            }

            const data = {
                'dataset': db_selected,
                'segmentor_data': segmentor_data,
                'translator_data': translator_data,
                'preparer_data': preparer_data
            };

            console.log(data)

            // LLAMADA AJAX
            fetch("/preprocess/Stage1", {
                method: "POST", 
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data), 
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP Error: ${response.status}`);
                    });
                }

                return response.json();
            })
            .then(response => {
                console.log('Success (' + response.status + '): ' + response.message);
                updateProgressBar();
                // step2Done = response.next_step_available;
            })
            .catch(error => {
                console.error("Error in Fetch/AJAX:", error.message);
                // alert('Error: ' + error.message);
            });

        } else {
            step1Done = false;
            alert('Please select an available dataset before accepting.');
        }
    }

    if (datasetButton) {
        datasetButton.addEventListener('click', Stage1Selection);
    }

    // === Listener para el botón de Confirmar del Step 2 (DEBES CREAR ESTE BOTÓN EN TU HTML) ===
    // Asumiendo que tienes un botón con id="confirmStep2" dentro del modal
    // const confirmStep2Button = document.getElementById('confirmStep2');
    // if (confirmStep2Button) {
    //     // confirmStep2Button.addEventListener('click', executeStep2Action);
    // }

    function updateStepDisplay() {
        footerBase.style.display = 'none';
        footerTwo.style.display = 'block';
        const slides = document.querySelectorAll('.step-slide');
        
        // 1. Aplicar clases para la animación
        slides.forEach((slide, index) => {
            const stepNum = index + 1;
            
            slide.classList.remove('active-slide', 'previous-slide');

            if (stepNum === currentSubStep) {
                slide.classList.add('active-slide');
            } else if (stepNum < currentSubStep) {
                slide.classList.add('previous-slide');
            }
        });
        
        // 2. Controlar la visibilidad y apariencia de los botones del footer
        // Botón Previous: Visible desde el paso 2 en adelante
        prevButton.style.display = currentSubStep > 1 ? 'block' : 'none';

        if (currentSubStep === totalSubSteps) {
            // Último paso: Cambiar a 'Accept Action'
            nextButton.textContent = 'Accept Action';
            nextButton.classList.remove('btn-primary');
            nextButton.classList.add('btn-success');
        } else {
            // Pasos intermedios: Volver a 'Next'
            nextButton.textContent = 'Next >';
            nextButton.setAttribute('data-dismiss', '');
            nextButton.classList.remove('btn-success');
            nextButton.classList.add('btn-primary');
        }
        
        // 3. Actualizar la información visual
        if (document.getElementById('dbSelectedFinal')) {
            document.getElementById('dbSelectedFinal').textContent = db_selected;
        }
    }
    
    // Listener para el botón 'Previous'
    if (prevButton) {
        prevButton.addEventListener('click', () => {
            if (currentSubStep > 1) {
                currentSubStep--;
                updateStepDisplay();
            }
        });
    }

    // =========================================================================
    // LÓGICA DEL BOTÓN 'Next / Accept Action'
    // =========================================================================

    if (nextButton) {
        nextButton.addEventListener('click', () => {
            if (currentSubStep < totalSubSteps) {
                // AVANZAR AL SIGUIENTE PASO
                currentSubStep++;
                updateStepDisplay();
            }
            else {
                // ÚLTIMO PASO: EJECUTAR LA ACCIÓN AJAX
                nextButton.setAttribute('data-dismiss', 'modal');
            }
        });
    }
    
    document.querySelectorAll('.step-box').forEach(box => {
        box.addEventListener('click', () => {
            const step = box.getAttribute('data-step');
            
            if (step === "1") {
                modalTitle.textContent = `Step ${step}: Data Selection`;

                bodyOne.style.display = 'block';
                bodyTwo.style.display = 'none';
                bodyBase.style.display = 'none';

                footerTwo.style.display = 'none';
                footerBase.style.display = 'block';
            }

            else if (step === "2") {
              modalTitle.textContent = `Step ${step}: Preprocessing`;

              bodyOne.style.display = 'none';
              bodyTwo.style.display = 'none';
              bodyBase.style.display = 'block';
              
              footerTwo.style.display = 'none';
              footerBase.style.display = 'block';

              if (!step1Done) {
                bodyBase.textContent = `Please do Step 1: Data Selection.`;
              }
              else {
                // Mostrar la interfaz del Step 2 y el botón de Confirmar
                bodyBase.style.display = 'none';
                bodyTwo.style.display = 'block';
                currentSubStep = 1;
                document.getElementById('dbSelectedStep2').textContent = db_selected;
                updateStepDisplay();
              }
            }

            else {
                modalTitle.textContent = `Step ${step} Details`;

                bodyOne.style.display = 'none';
                bodyTwo.style.display = 'none';
                bodyBase.style.display = 'block';

                footerTwo.style.display = 'none';
                footerBase.style.display = 'block';
                
                bodyBase.textContent = `This is where content for Step ${step} will go.`;
            }
        });
    });
});
</script>
{% endblock %}
