{% extends "base.html" %}
{% block title %}Profile{% endblock %}

{% block content %}
<h1 class="mt-5" style="margin-top: -5px;"> {{ username }}'s profile  </h1>
<hr>

<h2 class="mt-3">Upload Datasets</h2>
<p class="text-muted">Upload your dataset files (.parquet, .csv)</p>

<form id="upload-form" enctype="multipart/form-data">
    <div class="border rounded p-4 text-center bg-light" id="drop-zone">
        <p class="mb-2">Drag & drop your file here, or click to select</p>
        <input type="file" name="dataset_file" id="file-input" class="d-none" accept=".parquet,.csv" required>
        <button type="button" class="btn btn-outline-primary btn-sm" id="browse-btn">Choose File</button>
        <p class="mt-2 text-muted" id="file-name"></p>
    </div>

    <div class="d-flex align-items-center justify-content-between mt-3">
        <div class="d-flex align-items-center" style="gap: 10px;">
            <label for="action-select" class="mb-0">Choose a Stage:</label>
            <select id="action-select" name="action" class="form-select" required style="width: auto;">
                <option value="" disabled selected>Select an option</option>
                <option value="1_RawData">Raw Data</option>
                <option value="2_PreprocessData">Preprocessed Data</option>
                <!-- <option value="3_Download">Download</option> -->
            </select>
        </div>

        <button type="submit" class="btn btn-success" id="btn-success-files">Upload Dataset</button>
    </div>

    <div id="sep-csv" style="display: none;" class="mt-3">
        <label for="sep-select">Indicate a separator for csv:</label>
        <select id="sep-select" name="sep-csv" class="form-select">
            <option value="" disabled selected>Select an option</option>
            <option value=",">,</option>
            <option value=";">;</option>
        </select>
    </div>
</form>

<hr>

<h2 class="mt-3" style="margin-bottom: 20px;">Update {{ username }}'s information</h2>
<form method="POST" action="/profile">
    <div class="form-group">
        <label for="username">Username</label>
        <input type="text" class="form-control" id="username" name="username" placeholder="{{ username }}" >
    </div>
    <div class="form-group">
        <label for="email">Email address</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="{{ user_id }}" >
    </div>
    <div class="form-group">
        <label for="password">Password</label>
        <input type="password" class="form-control" id="password" name="password" >
    </div>
    <div class="form-group">
        <label for="password">Confirm password</label>
        <input type="password" class="form-control" id="password_rep" name="password_rep" >
    </div>
    <button type="submit" class="btn btn-primary">Update Profile</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const fileNameDisplay = document.getElementById('file-name');
    const uploadForm = document.getElementById('upload-form');
    const actionSelect = document.getElementById('action-select');

    const sepCsvDiv = document.getElementById('sep-csv');
    const separatorSelect = document.getElementById('sep-select');
    const csvSeparatorSelect = document.querySelector('#sep-csv select[name="sep-csv"]');

    function csvSeparatorDisplay(file) {
        if (file && file.name.toLowerCase().endsWith('.csv')) {
            sepCsvDiv.style.display = 'block';
        } else {
            sepCsvDiv.style.display = 'none';
        }
    }

    browseBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        fileNameDisplay.textContent = file?.name || '';
        csvSeparatorDisplay(file);
    });

    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-primary');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-primary');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary');
        const file = e.dataTransfer.files[0];
        
        if (file) {
            fileInput.files = e.dataTransfer.files;
            fileNameDisplay.textContent = file.name;
            csvSeparatorDisplay(file);
        }
    });

    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) return alert("Please select a file first.");

        let stage = actionSelect.value;
        if (!stage) return alert("Please select an stage.");

        const buttonSubmit = document.getElementById('btn-success-files')
        buttonSubmit.disabled = true;
        buttonSubmit.textContent = 'Uploading...';

        stage = stage.replace(/\s+/g, "_");

        const formData = new FormData();
        formData.append('file', file);
        formData.append('stage', stage);
        
        const esCsv = file.name.toLowerCase().endsWith('.csv');
        if (esCsv) {
            const separator = csvSeparatorSelect.value;
            if (!separator) {
                alert("Please select a separator for the CSV file.");
                buttonSubmit.disabled = false;
                buttonSubmit.textContent = 'Upload Dataset';
                return;
            }
            formData.append('sep', separator);
        }

        fetch('/upload_dataset', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message || data.error);
            buttonSubmit.disabled = false;
            buttonSubmit.textContent = 'Upload Dataset';
        })
        .catch(err => {
            console.error(err);
            buttonSubmit.disabled = false;
            buttonSubmit.textContent = 'Upload Dataset';
        });
    });
});
</script>

{% endblock %}
